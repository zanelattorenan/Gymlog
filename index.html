<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="manifest" href="manifest.json"> 
  <meta name="theme-color" content="#0f172a">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GymLog – Treinos</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col items-center justify-center">

  <!-- TELA DE LOGIN -->
  <div id="login-screen" class="w-full max-w-md bg-white shadow-lg rounded-xl m-3 p-4 space-y-4">
    <h1 class="text-xl font-bold text-slate-800 text-center">
      GymLog – Acesso
    </h1>
    <p class="text-xs text-slate-500 text-center">
      Crie um usuário para guardar seus treinos neste dispositivo.
    </p>

    <div class="space-y-2">
      <label class="text-sm font-medium block" for="login-username">Usuário</label>
      <input id="login-username" type="text" class="w-full border rounded px-3 py-2 text-sm"
             placeholder="ex: João/Maria" />
    </div>

    <div class="space-y-2">
      <label class="text-sm font-medium block" for="login-password">Senha</label>
      <input id="login-password" type="password" class="w-full border rounded px-3 py-2 text-sm"
             placeholder="mínimo 4 caracteres" />
    </div>

    <div class="flex flex-col sm:flex-row gap-2 mt-2">
      <button class="flex-1 bg-blue-600 text-white text-sm py-2 rounded hover:bg-blue-700"
              onclick="handleLogin()">
        Entrar
      </button>
      <button class="flex-1 border border-blue-600 text-blue-600 text-sm py-2 rounded hover:bg-blue-50"
              onclick="handleRegister()">
        Criar conta
      </button>
    </div>

    <p id="login-msg" class="text-xs text-center text-red-500 h-4"></p>

   
  </div>

  <!-- APP PRINCIPAL -->
  <div id="app-screen" class="hidden w-full max-w-3xl bg-white shadow-lg rounded-xl m-3 p-4 space-y-4">
    <div class="flex justify-between items-start gap-2">
      <h1 class="text-2xl font-bold text-slate-800">
        GymLog
      </h1>
      <div class="text-right text-xs">
        <div id="user-label" class="text-slate-500 mb-1"></div>
        <button class="border border-slate-300 px-2 py-1 rounded hover:bg-slate-100"
                onclick="logout()">
          Sair
        </button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex border-b text-sm">
      <button id="tab-today" class="px-4 py-2 border-b-2 border-blue-600 text-blue-600 font-semibold"
              onclick="switchView('today')">Treino de hoje</button>
      <button id="tab-calendar" class="px-4 py-2 text-slate-600"
              onclick="switchView('calendar')">Calendário</button>
      <button id="tab-history" class="px-4 py-2 text-slate-600"
              onclick="switchView('history')">Histórico</button>
      <button id="tab-config" class="px-4 py-2 text-slate-600"
              onclick="switchView('config')">Configurar </button>
    </div>

    <!-- Treino de hoje -->
    <section id="view-today" class="space-y-4">
      <p class="text-sm text-slate-500">
        Hoje: <span id="today-date" class="font-semibold"></span>
      </p>

      <div>
        <p class="text-sm font-medium mb-1">Selecione o treino do dia:</p>
        <div id="workout-buttons" class="flex gap-2 flex-wrap">
          <!-- Botões de  dinâmicos -->
        </div>
      </div>

      <div id="exercise-list" class="space-y-3">
        <p class="text-slate-500 text-sm italic">
          Escolha um treino para ver os exercícios.
        </p>
      </div>

      <button id="save-today-btn"
              class="hidden w-full bg-emerald-600 text-white font-semibold py-2 rounded-lg hover:bg-emerald-700 text-sm"
              onclick="saveToday()">
        Salvar treino de hoje
      </button>

      <p id="msg" class="text-xs text-center text-slate-500"></p>
    </section>

    <!-- Calendário -->
    <section id="view-calendar" class="space-y-4 hidden">
      <div class="flex items-center justify-between">
        <button class="p-1" onclick="changeMonth(-1)">&#9664;</button>
        <p id="month-label" class="font-semibold"></p>
        <button class="p-1" onclick="changeMonth(1)">&#9654;</button>
      </div>

      <div class="grid grid-cols-7 text-center text-xs font-medium text-slate-500">
        <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
      </div>
      <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-xs"></div>

      <div id="day-details" class="hidden border rounded-lg p-3 bg-slate-50 space-y-2">
        <div class="flex justify-between items-center">
          <p id="day-details-title" class="font-semibold mb-1"></p>
          <button class="text-xs text-red-600 underline"
                  onclick="deleteDayLogs()">
            Excluir todos registros deste dia
          </button>
        </div>
        <div id="day-details-body" class="space-y-1 text-sm"></div>
      </div>
    </section>

    <!-- Histórico por exercício -->
    <section id="view-history" class="space-y-4 hidden">
      <div>
        <label class="text-sm font-medium block mb-1">Escolha um exercício:</label>
        <select id="exercise-select" class="w-full border rounded-lg p-2 text-sm"
                onchange="renderExerciseHistory()">
          <option value="">-- selecione --</option>
        </select>
      </div>
      <div id="exercise-history" class="space-y-2 text-sm">
        <p class="text-slate-500 italic text-sm">
          Selecione um exercício para ver a evolução da carga.
        </p>
      </div>
    </section>

    <!-- Configurar  -->
    <section id="view-config" class="space-y-4 hidden">
      <p class="text-sm text-slate-600">
        Aqui você pode criar  (A, B, C...) e adicionar/remover/editar exercícios,
        com lista de exercícios prontos + vídeos.
      </p>

      <!-- Adicionar treino -->
      <div class="mb-2 space-y-2">
        <p class="text-sm font-medium"> disponíveis</p>
        <div class="flex gap-2 items-center text-xs">
          <input id="cfg-new-workout-letter" type="text" maxlength="1"
                 class="w-10 border rounded px-2 py-1 text-center uppercase"
                 placeholder="F">
          <input id="cfg-new-workout-name" type="text"
                 class="flex-1 border rounded px-2 py-1"
                 placeholder="Nome opcional (ex: Inferiores)">
          <button class="px-3 py-1 bg-emerald-600 text-white rounded text-xs"
                  onclick="addWorkoutConfig()">
            Adicionar treino
          </button>
        </div>
      </div>

      <div>
        <p class="text-xs text-slate-500 mb-1">Clique em um treino para editar os exercícios.</p>
        <div id="config-buttons" class="flex gap-2 flex-wrap"></div>
      </div>

      <div id="config-current" class="border rounded-lg p-3 bg-slate-50 space-y-3 hidden">
        <div class="flex justify-between items-center">
          <p id="config-title" class="font-semibold text-sm"></p>
          <div class="flex gap-2">
            <button class="text-xs text-red-500 underline"
                    onclick="deleteCurrentWorkout()">
              Excluir treino
            </button>
          </div>
        </div>

        <!-- Formulário exercício -->
        <div class="space-y-2">
          <p id="cfg-form-title" class="text-xs font-medium text-slate-600">Adicionar exercício</p>

          <!-- Lista suspensa de exercícios prontos -->
          <div>
            <label class="block text-xs text-slate-600 mb-1">
              Escolher exercício da lista (preenche nome, séries e vídeo):
            </label>
            <select id="cfg-template" class="w-full border rounded px-2 py-1 text-xs">
              <option value="">-- escolher da lista --</option>
            </select>
          </div>

          <div class="flex flex-col gap-2 sm:flex-row mt-1">
            <input id="cfg-name" type="text" placeholder="Nome (ex: Agachamento livre)"
                   class="flex-1 border rounded px-2 py-1 text-sm">
            <input id="cfg-reps" type="text" placeholder="Séries/reps (ex: 4x12)"
                   class="flex-1 border rounded px-2 py-1 text-sm">
          </div>
          <input id="cfg-gif" type="text" placeholder="URL do vídeo (YouTube)"
                 class="w-full border rounded px-2 py-1 text-sm">

          <div class="flex gap-2 mt-1">
            <button id="cfg-add-btn"
                    class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700"
                    onclick="submitExerciseConfig()">
              Adicionar exercício
            </button>
            <button id="cfg-cancel-edit-btn"
                    class="hidden px-3 py-1 bg-slate-300 text-slate-800 text-xs rounded hover:bg-slate-400"
                    onclick="cancelEditExercise()">
              Cancelar edição
            </button>
          </div>
        </div>

        <div id="config-exercise-list" class="space-y-2 text-sm">
          <!-- lista de exercícios -->
        </div>

        <div class="flex flex-wrap gap-3 mt-2">
          <button class="text-xs text-red-600 underline"
                  onclick="resetCurrentWorkoutToDefault()">
            Voltar treino selecionado para o padrão inicial (A–E)
          </button>
        </div>
      </div>

      <button class="text-xs text-red-500 underline"
              onclick="resetAllWorkouts()">
        Resetar TODOS os  para o padrão inicial (A–E)
      </button>
    </section>
  </div>

  <script>
    // ---------- Login / Usuários ----------
    const USERS_KEY = "gymlog-users-v1";
    const LOGS_KEY_BASE = "gymlog-registros-v1-";
    const WORKOUTS_KEY_BASE = "gymlog-workouts-v1-";

    let currentUser = null;
    let logs = [];
    let workouts = {};
    let selectedWorkout = null;
    let currentMonth = new Date();
    let configWorkout = null;
    let editExerciseIndex = null;
    let lastDayDetailsDate = null;

    function loadUsers() {
      try {
        return JSON.parse(localStorage.getItem(USERS_KEY)) || {};
      } catch {
        return {};
      }
    }
    function saveUsers(users) {
      localStorage.setItem(USERS_KEY, JSON.stringify(users));
    }

    function getLogsKey() {
      return LOGS_KEY_BASE + currentUser;
    }
    function getWorkoutsKey() {
      return WORKOUTS_KEY_BASE + currentUser;
    }

    function loadLogs() {
      if (!currentUser) return [];
      try { return JSON.parse(localStorage.getItem(getLogsKey())) || []; }
      catch { return []; }
    }
    function saveLogsData(logsData) {
      if (!currentUser) return;
      localStorage.setItem(getLogsKey(), JSON.stringify(logsData));
    }

    function cloneDefaultWorkouts() {
      if (typeof structuredClone === "function") {
        return structuredClone(DEFAULT_WORKOUTS);
      }
      return JSON.parse(JSON.stringify(DEFAULT_WORKOUTS));
    }

    function loadWorkouts() {
      if (!currentUser) return cloneDefaultWorkouts();
      try {
        const data = JSON.parse(localStorage.getItem(getWorkoutsKey()));
        return data || cloneDefaultWorkouts();
      } catch {
        return cloneDefaultWorkouts();
      }
    }
    function saveWorkouts() {
      if (!currentUser) return;
      localStorage.setItem(getWorkoutsKey(), JSON.stringify(workouts));
    }

    function showLoginMsg(text, isError = true) {
      const el = document.getElementById("login-msg");
      el.textContent = text || "";
      el.classList.remove("text-red-500", "text-emerald-600");
      el.classList.add(isError ? "text-red-500" : "text-emerald-600");
      if (text) {
        setTimeout(() => { el.textContent = ""; }, 4000);
      }
    }

  
     

    function handleRegister() {
      const username = document.getElementById("login-username").value.trim();
      const password = document.getElementById("login-password").value.trim();

      if (!username || username.length < 3) {
        showLoginMsg("Usuário deve ter pelo menos 3 caracteres.");
        return;
      }
      if (/\s/.test(username)) {
        showLoginMsg("Usuário não pode ter espaços.");
        return;
      }
      if (!password || password.length < 4) {
        showLoginMsg("Senha deve ter pelo menos 4 caracteres.");
        return;
      }

      const users = loadUsers();
      if (users[username]) {
        showLoginMsg("Esse usuário já existe. Use outro nome ou faça login.");
        return;
      }

      users[username] = { password };
      saveUsers(users);

      // cria  padrão A–E e zera logs
      currentUser = username;
      workouts = cloneDefaultWorkouts();
      logs = [];
      saveWorkouts();
      saveLogsData(logs);

      showLoginMsg("Conta criada e login realizado.", false);
      setTimeout(() => {
        enterApp(username);
      }, 500);
      
    }

    function handleLogin() {
      const username = document.getElementById("login-username").value.trim();
      const password = document.getElementById("login-password").value.trim();

      if (!username || !password) {
        showLoginMsg("Preencha usuário e senha.");
        return;
      }

      const users = loadUsers();
      if (!users[username]) {
        showLoginMsg("Usuário não encontrado. Crie uma conta.");
        return;
      }
      if (users[username].password !== password) {
        showLoginMsg("Senha incorreta.");
        return;
      }

      enterApp(username);
    }

    function enterApp(username) {
      currentUser = username;
      logs = loadLogs();
      workouts = loadWorkouts();

      document.getElementById("user-label").textContent =
        "Usuário: " + currentUser;

      document.getElementById("login-screen").classList.add("hidden");
      document.getElementById("app-screen").classList.remove("hidden");

      initAppForUser();
    }

    function logout() {
      currentUser = null;
      logs = [];
      workouts = {};
      selectedWorkout = null;
      configWorkout = null;
      editExerciseIndex = null;
      lastDayDetailsDate = null;

      document.getElementById("app-screen").classList.add("hidden");
      document.getElementById("login-screen").classList.remove("hidden");
      document.getElementById("login-password").value = "";
      showLoginMsg("");
      refreshLoginUsersInfo();
    }

    // ---------- Helper: gera URL de demonstração no YouTube ----------
    function demoUrl(nomeExercicio) {
      const query = `${nomeExercicio} exercício academia execução correta`;
      return `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
    }

    // ---------- Dados padrão dos  A–E ----------
    const DEFAULT_WORKOUTS = {
      A: {
        nome: "Treino A (Quadríceps / Glúteo)",
        exercises: [
          { name: "Agachamento no smith",         reps: "4x12",            gif: demoUrl("Agachamento no smith") },
          { name: "Leg 45º",                      reps: "4x10",            gif: demoUrl("Leg 45") },
          { name: "Afundo",                       reps: "3x10 cada perna", gif: demoUrl("Afundo com halteres") },
          { name: "Cadeira extensora",            reps: "4x12",            gif: demoUrl("Cadeira extensora") },
          { name: "Adutora máquina",              reps: "4x10",            gif: demoUrl("Adutora máquina") },
          { name: "Panturrilha na máquina",       reps: "4x15",            gif: demoUrl("Panturrilha em pé na máquina") },
          { name: "Abdominal supra",              reps: "4x15",            gif: demoUrl("Abdominal supra no solo") },
        ],
      },
      B: {
        nome: "Treino B (Costas / Bíceps)",
        exercises: [
          { name: "Puxador frente",               reps: "4x12",            gif: demoUrl("Puxada frente barra aberta polia") },
          { name: "Remada baixa aberta",          reps: "4x10",            gif: demoUrl("Remada baixa aberta polia") },
          { name: "Remada curvada cavalinho",     reps: "4x12",            gif: demoUrl("Remada cavalinho máquina") },
          { name: "Rosca corda polia",            reps: "4x12",            gif: demoUrl("Rosca bíceps corda polia") },
          { name: "Rosca Scott",                  reps: "4x10",            gif: demoUrl("Rosca Scott barra") },
          { name: "Face pull",                    reps: "4x12",            gif: demoUrl("Face pull polia alta") },
          { name: "Abdominal infra",              reps: "4x10",            gif: demoUrl("Abdominal infra no banco") },
        ],
      },
      C: {
        nome: "Treino C (Posterior / Glúteo)",
        exercises: [
          { name: "Agachamento sumô com halteres", reps: "4x12",           gif: demoUrl("Agachamento sumô com halteres") },
          { name: "Mesa flexora",                 reps: "4x10",            gif: demoUrl("Mesa flexora") },
          { name: "Cadeira flexora",              reps: "4x12",            gif: demoUrl("Cadeira flexora") },
          { name: "Cadeira abdutora",             reps: "4x15",            gif: demoUrl("Cadeira abdutora") },
          { name: "Elevação pélvica",             reps: "4x10",            gif: demoUrl("Elevação pélvica com barra") },
          { name: "Panturrilha no smith",         reps: "4x15",            gif: demoUrl("Panturrilha em pé no smith") },
          { name: "Abdominal oblíquo",            reps: "4x20 totais",     gif: demoUrl("Abdominal oblíquo solo") },
        ],
      },
      D: {
        nome: "Treino D (Peito / Ombro / Tríceps)",
        exercises: [
          { name: "Supino reto máquina",          reps: "4x12",            gif: demoUrl("Supino reto na máquina") },
          { name: "Supino inclinado máquina",     reps: "3x12",            gif: demoUrl("Supino inclinado na máquina") },
          { name: "Fly",                          reps: "4x12",            gif: demoUrl("Fly peck deck máquina") },
          { name: "Tríceps corda",                reps: "4x12",            gif: demoUrl("Tríceps corda polia alta") },
          { name: "Tríceps máquina",              reps: "3x15",            gif: demoUrl("Tríceps na máquina") },
          { name: "Elevação lateral com halteres",reps: "4x12",            gif: demoUrl("Elevação lateral com halteres") },
          { name: "Hiperextensão lombar",         reps: "4x10",            gif: demoUrl("Hiperextensão lombar no banco romano") },
        ],
      },
      E: {
        nome: "Treino E (Quadríceps / Posterior / Glúteo)",
        exercises: [
          { name: "Agachamento smith",            reps: "4x10",            gif: demoUrl("Agachamento no smith") },
          { name: "Leg 45º",                      reps: "4x10",            gif: demoUrl("Leg 45") },
          { name: "Cadeira extensora",            reps: "4x12",            gif: demoUrl("Cadeira extensora") },
          { name: "Mesa flexora",                 reps: "4x10",            gif: demoUrl("Mesa flexora") },
          { name: "Abdutora",                     reps: "3x15",            gif: demoUrl("Cadeira abdutora") },
          { name: "Elevação pélvica",             reps: "4x12",            gif: demoUrl("Elevação pélvica com barra") },
          { name: "Panturrilha na máquina",       reps: "4x15",            gif: demoUrl("Panturrilha em pé na máquina") },
        ],
      },
    };

    // ---------- Lista suspensa de exercícios prontos ----------
    const EXERCISE_TEMPLATES = [
      // Perna / Glúteo
      { id: "agach-livre",   grupo: "Perna / Glúteo", name: "Agachamento livre",           reps: "4x8-12",           url: demoUrl("Agachamento livre barra alta") },
      { id: "agach-smith",   grupo: "Perna / Glúteo", name: "Agachamento no smith",        reps: "4x10-12",          url: demoUrl("Agachamento no smith") },
      { id: "bulgaro",       grupo: "Perna / Glúteo", name: "Agachamento búlgaro",         reps: "3x10 cada perna",  url: demoUrl("Agachamento búlgaro com banco") },
      { id: "avanço",        grupo: "Perna / Glúteo", name: "Avanço com halteres",         reps: "3x10 cada perna",  url: demoUrl("Avanço com halteres") },
      { id: "leg45",         grupo: "Perna / Glúteo", name: "Leg 45º",                     reps: "4x10",             url: demoUrl("Leg press 45") },
      { id: "extensora",     grupo: "Perna / Glúteo", name: "Cadeira extensora",           reps: "3-4x12",           url: demoUrl("Cadeira extensora") },
      { id: "flex-mesa",     grupo: "Perna / Glúteo", name: "Mesa flexora",                reps: "3-4x10-12",        url: demoUrl("Mesa flexora deitado") },
      { id: "flex-cadeira",  grupo: "Perna / Glúteo", name: "Cadeira flexora",             reps: "3-4x12",           url: demoUrl("Cadeira flexora sentado") },
      { id: "abdutora",      grupo: "Perna / Glúteo", name: "Cadeira abdutora",            reps: "3x15",             url: demoUrl("Cadeira abdutora") },
      { id: "adutora",       grupo: "Perna / Glúteo", name: "Adutora máquina",             reps: "3x15",             url: demoUrl("Cadeira adutora") },
      { id: "elev-pelvica",  grupo: "Perna / Glúteo", name: "Elevação pélvica",            reps: "4x10-12",          url: demoUrl("Hip thrust elevação pélvica") },
      { id: "pant-maq",      grupo: "Perna / Glúteo", name: "Panturrilha na máquina",      reps: "4x15-20",          url: demoUrl("Panturrilha em pé máquina") },
      { id: "pant-smith",    grupo: "Perna / Glúteo", name: "Panturrilha no smith",        reps: "4x15-20",          url: demoUrl("Panturrilha em pé no smith") },

      // Costas / Bíceps
      { id: "pux-frente",    grupo: "Costas / Bíceps", name: "Puxador frente",             reps: "4x10-12",          url: demoUrl("Puxada frente barra aberta polia alta") },
      { id: "pux-sup",       grupo: "Costas / Bíceps", name: "Puxador frente supinado",    reps: "4x10-12",          url: demoUrl("Puxada frente pegada supinada") },
      { id: "rem-curv-bar",  grupo: "Costas / Bíceps", name: "Remada curvada barra",       reps: "4x8-10",           url: demoUrl("Remada curvada barra") },
      { id: "rem-caval",     grupo: "Costas / Bíceps", name: "Remada cavalinho",           reps: "4x10-12",          url: demoUrl("Remada cavalinho máquina") },
      { id: "rem-baixa",     grupo: "Costas / Bíceps", name: "Remada baixa",               reps: "4x10-12",          url: demoUrl("Remada baixa polia") },
      { id: "rosca-direta",  grupo: "Costas / Bíceps", name: "Rosca direta barra",         reps: "3-4x8-12",         url: demoUrl("Rosca direta barra w") },
      { id: "rosca-alt",     grupo: "Costas / Bíceps", name: "Rosca alternada",            reps: "3x10-12",          url: demoUrl("Rosca alternada halteres") },
      { id: "rosca-martelo", grupo: "Costas / Bíceps", name: "Rosca martelo",              reps: "3x10-12",          url: demoUrl("Rosca martelo halteres") },

      // Peito / Ombro / Tríceps
      { id: "sup-reto-bar",  grupo: "Peito / Ombro / Tríceps", name: "Supino reto barra",  reps: "4x8-10",           url: demoUrl("Supino reto barra") },
      { id: "sup-reto-maq",  grupo: "Peito / Ombro / Tríceps", name: "Supino reto máquina",reps: "4x10-12",          url: demoUrl("Supino reto na máquina") },
      { id: "sup-incl-hal",  grupo: "Peito / Ombro / Tríceps", name: "Supino inclinado halteres", reps: "3-4x8-12", url: demoUrl("Supino inclinado halteres") },
      { id: "fly-maq",       grupo: "Peito / Ombro / Tríceps", name: "Fly máquina (peck deck)", reps: "3-4x10-12",   url: demoUrl("Fly peck deck") },
      { id: "desenv-hal",    grupo: "Peito / Ombro / Tríceps", name: "Desenvolvimento com halteres", reps: "3-4x8-12", url: demoUrl("Desenvolvimento ombro halteres sentado") },
      { id: "ele-lateral",   grupo: "Peito / Ombro / Tríceps", name: "Elevação lateral",   reps: "3-4x12-15",        url: demoUrl("Elevação lateral ombro halteres") },
      { id: "tric-corda",    grupo: "Peito / Ombro / Tríceps", name: "Tríceps corda polia alta", reps: "3-4x10-12",  url: demoUrl("Tríceps corda polia alta") },
      { id: "tric-testa",    grupo: "Peito / Ombro / Tríceps", name: "Tríceps testa",      reps: "3x10-12",          url: demoUrl("Tríceps testa barra w") },
      { id: "merg-banco",    grupo: "Peito / Ombro / Tríceps", name: "Mergulho no banco",  reps: "3x10-15",          url: demoUrl("Mergulho banco tríceps") },

      // Core / Abdômen
      { id: "abd-supra",     grupo: "Core / Abdômen", name: "Abdominal supra",             reps: "3-4x15-20",        url: demoUrl("Abdominal supra no solo") },
      { id: "abd-infra",     grupo: "Core / Abdômen", name: "Abdominal infra",             reps: "3-4x15-20",        url: demoUrl("Abdominal infra no banco") },
      { id: "abd-obliquo",   grupo: "Core / Abdômen", name: "Abdominal oblíquo",           reps: "3-4x20 totais",    url: demoUrl("Abdominal oblíquo solo") },
      { id: "prancha",       grupo: "Core / Abdômen", name: "Prancha isométrica",          reps: "3x30-40s",         url: demoUrl("Prancha isométrica abdômen") },
      { id: "prancha-lat",   grupo: "Core / Abdômen", name: "Prancha lateral",             reps: "3x20-30s cada lado", url: demoUrl("Prancha lateral isométrica") },
    ];

    // ---------- Util ----------
    function todayISO() {
      return new Date().toISOString().slice(0, 10);
    }
    function formatBR(dateISO) {
      const [y, m, d] = dateISO.split("-");
      return `${d}/${m}/${y}`;
    }

    function showMsg(text) {
      const el = document.getElementById("msg");
      el.textContent = text;
      if (!text) return;
      setTimeout(() => { el.textContent = ""; }, 3000);
    }

    // ---------- Tabs ----------
    function switchView(view) {
      ["today","calendar","history","config"].forEach(v => {
        document.getElementById("view-" + v).classList.add("hidden");
        document.getElementById("tab-" + v).classList.remove(
          "border-b-2","border-blue-600","text-blue-600","font-semibold"
        );
      });

      document.getElementById("view-" + view).classList.remove("hidden");
      document.getElementById("tab-" + view).classList.add(
        "border-b-2","border-blue-600","text-blue-600","font-semibold"
      );

      if (view === "calendar") renderCalendar();
      if (view === "history") {
        fillExerciseSelect();
        renderExerciseHistory();
      }
      if (view === "config") {
        renderConfigButtons();
        renderConfigPanel();
      }
    }

    // ---------- Treino de hoje ----------
    function renderWorkoutButtons() {
      const container = document.getElementById("workout-buttons");
      container.innerHTML = "";

      const keys = Object.keys(workouts).sort();
      if (!keys.length) {
        container.innerHTML = "<p class='text-xs text-slate-500'>Nenhum treino cadastrado. Crie um na aba Configurar .</p>";
        selectedWorkout = null;
        document.getElementById("save-today-btn").classList.add("hidden");
        document.getElementById("exercise-list").innerHTML =
          "<p class='text-xs text-slate-500'>Sem . Vá em Configurar .</p>";
        return;
      }

      keys.forEach(letter => {
        const btn = document.createElement("button");
        btn.textContent = letter;
        btn.className =
          "px-3 py-1 rounded-full border text-sm " +
          "hover:bg-blue-50 hover:border-blue-500";
        if (letter === selectedWorkout) {
          btn.classList.add("bg-blue-600","text-white","border-blue-600");
        }
        btn.onclick = () => selectWorkout(letter);
        container.appendChild(btn);
      });
    }

    function selectWorkout(letter) {
      selectedWorkout = letter;
      document.querySelectorAll("#workout-buttons button").forEach(b => {
        b.classList.remove("bg-blue-600","text-white","border-blue-600");
      });
      const btn = Array.from(document.querySelectorAll("#workout-buttons button"))
        .find(b => b.textContent === letter);
      if (btn) btn.classList.add("bg-blue-600","text-white","border-blue-600");

      renderExerciseList();
    }

    function openGif(name, url) {
      if (!url) {
        alert("Nenhum vídeo cadastrado para: " + name);
        return;
      }
      window.open(url, "_blank");
    }

    function renderExerciseList() {
      const container = document.getElementById("exercise-list");
      const btnSave = document.getElementById("save-today-btn");
      if (!selectedWorkout || !workouts[selectedWorkout]) {
        container.innerHTML = "<p class='text-slate-500 text-sm italic'>Selecione um treino.</p>";
        btnSave.classList.add("hidden");
        return;
      }
      const workout = workouts[selectedWorkout];
      const today = todayISO();

      const lastByExercise = {};
      logs
        .filter(l => l.exercise && l.date === today && l.workout === selectedWorkout)
        .forEach(l => { lastByExercise[l.exercise] = l; });

      const html = workout.exercises.map(ex => {
        const last = logs
          .filter(l => l.exercise === ex.name)
          .sort((a,b) => b.timestamp - a.timestamp)[0];
        const todayLast = lastByExercise[ex.name];
        const lastText = last
          ? `<span class="text-xs text-slate-500">Última: ${last.weight} kg em ${formatBR(last.date)} (Treino ${last.workout})</span>`
          : "";
        const initWeight = todayLast ? todayLast.weight : "";
        const initObs = todayLast ? todayLast.note : "";

        const safeName = ex.name.replace(/"/g, '&quot;');
        const safeGif = ex.gif ? ex.gif.replace(/'/g,"&#39;") : "";

        return `
          <div class="border rounded-lg p-3 bg-slate-50 space-y-1" data-ex="${safeName}">
            <button type="button"
                    class="font-medium text-sm text-blue-700 hover:underline text-left"
                    onclick="openGif('${safeName}','${safeGif}')">
              ${safeName}
            </button>
            <p class="text-xs text-slate-500">Séries / reps: ${ex.reps}</p>
            ${lastText}
            <div class="flex gap-2 mt-1">
              <input type="number" step="0.5" placeholder="kg"
                     class="w-24 border rounded px-2 text-sm"
                     value="${initWeight}" />
              <input type="text" placeholder="obs"
                     class="flex-1 border rounded px-2 text-sm"
                     value="${initObs}" />
            </div>
          </div>
        `;
      }).join("");
      container.innerHTML = html || "<p class='text-xs text-slate-500'>Nenhum exercício neste treino.</p>";
      btnSave.classList.remove("hidden");
    }

    function saveToday() {
      if (!selectedWorkout) {
        showMsg("Selecione um treino antes de salvar.");
        return;
      }
      const date = todayISO();
      const items = document.querySelectorAll("#exercise-list [data-ex]");
      const newLogs = [];

      items.forEach(div => {
        const name = div.dataset.ex;
        const [weightInput, noteInput] = div.querySelectorAll("input");
        const weight = parseFloat(weightInput.value.replace(",", ".")) || 0;
        const note = noteInput.value.trim();
        if (weight > 0 || note) {
          newLogs.push({
            date,
            workout: selectedWorkout,
            exercise: name,
            weight,
            note,
            timestamp: Date.now(),
          });
        }
      });

      if (!newLogs.length) {
        showMsg("Nenhum exercício com carga/obs preenchida.");
        return;
      }

      logs = logs.concat(newLogs);
      saveLogsData(logs);
      showMsg(`Treino ${selectedWorkout} salvo com ${newLogs.length} registros.`);
      renderCalendar();
      fillExerciseSelect();
      renderExerciseHistory();
    }

    // ---------- Calendário ----------
    function changeMonth(delta) {
      currentMonth.setMonth(currentMonth.getMonth() + delta);
      renderCalendar();
    }

    function renderCalendar() {
      const label = document.getElementById("month-label");
      const grid = document.getElementById("calendar-grid");
      const y = currentMonth.getFullYear();
      const m = currentMonth.getMonth();
      label.textContent = currentMonth.toLocaleDateString("pt-BR", {
        month: "long",
        year: "numeric",
      });

      grid.innerHTML = "";
      const first = new Date(y, m, 1);
      const firstWeekday = first.getDay();
      const daysInMonth = new Date(y, m + 1, 0).getDate();

      for (let i = 0; i < firstWeekday; i++) {
        grid.innerHTML += "<div></div>";
      }

      const byDate = {};
      logs.forEach(l => {
        if (!byDate[l.date]) byDate[l.date] = new Set();
        byDate[l.date].add(l.workout);
      });

      for (let d = 1; d <= daysInMonth; d++) {
        const dateISO = `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        const workoutsSet = byDate[dateISO];
        let labelWorkout = "";
        if (workoutsSet) {
          const arr = Array.from(workoutsSet);
          labelWorkout = arr.length === 1 ? arr[0] : "+";
        }
        const hasWorkout = !!workoutsSet;

        const baseClasses =
          "border rounded-lg h-12 flex flex-col items-center justify-center cursor-pointer text-xs";
        const classes = hasWorkout
          ? baseClasses + " bg-blue-600 text-white"
          : baseClasses + " bg-white text-slate-700 hover:bg-slate-50";

        grid.innerHTML += `
          <div class="${classes}" onclick="showDayDetails('${dateISO}')">
            <span>${d}</span>
            ${labelWorkout ? `<span class="font-bold text-sm">${labelWorkout}</span>` : ""}
          </div>
        `;
      }

      document.getElementById("day-details").classList.add("hidden");
      lastDayDetailsDate = null;
    }

    function showDayDetails(dateISO) {
      const box = document.getElementById("day-details");
      const title = document.getElementById("day-details-title");
      const body = document.getElementById("day-details-body");

      lastDayDetailsDate = dateISO;

      const dayLogs = logs
        .filter(l => l.date === dateISO)
        .sort((a,b) => a.exercise.localeCompare(b.exercise));

      title.textContent = `Treinos em ${formatBR(dateISO)}`;
      if (!dayLogs.length) {
        body.innerHTML = "<p class='text-slate-500 text-sm'>Nenhum registro.</p>";
      } else {
        body.innerHTML = dayLogs.map(l => `
          <div class="flex justify-between border-b py-1">
            <div>
              <p class="text-sm font-medium">${l.exercise}</p>
              <p class="text-xs text-slate-500">
                Treino ${l.workout} – ${l.weight} kg
                ${l.note ? ` – ${l.note}` : ""}
              </p>
            </div>
          </div>
        `).join("");
      }
      box.classList.remove("hidden");
    }

    function deleteDayLogs() {
      if (!lastDayDetailsDate) return;
      if (!confirm(`Excluir TODOS os registros do dia ${formatBR(lastDayDetailsDate)}?`)) return;

      logs = logs.filter(l => l.date !== lastDayDetailsDate);
      saveLogsData(logs);
      renderCalendar();
      fillExerciseSelect();
      renderExerciseHistory();
      document.getElementById("day-details").classList.add("hidden");
      lastDayDetailsDate = null;
    }

    // ---------- Histórico por exercício ----------
    function fillExerciseSelect() {
      const select = document.getElementById("exercise-select");
      const existing = select.value;
      const allNames = new Set();
      Object.values(workouts).forEach(w => {
        w.exercises.forEach(e => allNames.add(e.name));
      });
      const list = Array.from(allNames).sort();
      select.innerHTML = '<option value="">-- selecione --</option>';
      list.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
      if (existing) select.value = existing;
    }

    function renderExerciseHistory() {
      const select = document.getElementById("exercise-select");
      const name = select.value;
      const container = document.getElementById("exercise-history");
      if (!name) {
        container.innerHTML =
          "<p class='text-slate-500 italic text-sm'>Selecione um exercício.</p>";
        return;
      }
      const hist = logs
        .filter(l => l.exercise === name)
        .sort((a,b) => b.timestamp - a.timestamp);

      if (!hist.length) {
        container.innerHTML =
          `<p class='text-slate-500 text-sm'>Nenhum registro ainda para "${name}".</p>`;
        return;
      }

      container.innerHTML = hist.map(l => `
        <div class="border-l-4 border-emerald-500 bg-emerald-50 px-3 py-2 flex justify-between">
          <div>
            <p class="text-sm font-semibold">${l.weight} kg</p>
            <p class="text-xs text-slate-600">
              Treino ${l.workout} – ${formatBR(l.date)}
              ${l.note ? `<br><span class="text-slate-500">Obs: ${l.note}</span>` : ""}
            </p>
          </div>
        </div>
      `).join("");
    }

    // ---------- Configurar treinos ----------
    function renderConfigButtons() {
      const container = document.getElementById("config-buttons");
      container.innerHTML = "";
      const keys = Object.keys(workouts).sort();
      if (!keys.length) {
        container.innerHTML = "<p class='text-xs text-slate-500'>Nenhum treino. Adicione um acima.</p>";
        return;
      }
      keys.forEach(letter => {
        const btn = document.createElement("button");
        btn.textContent = letter;
        btn.className =
          "px-3 py-1 rounded-full border text-sm " +
          "hover:bg-blue-50 hover:border-blue-500";
        if (configWorkout === letter) {
          btn.classList.add("bg-blue-600","text-white","border-blue-600");
        }
        btn.onclick = () => {
          configWorkout = letter;
          editExerciseIndex = null;
          resetConfigFormUI();
          renderConfigButtons();
          renderConfigPanel();
        };
        container.appendChild(btn);
      });
    }

    function renderConfigPanel() {
      const panel = document.getElementById("config-current");
      const title = document.getElementById("config-title");
      const list = document.getElementById("config-exercise-list");
      if (!configWorkout || !workouts[configWorkout]) {
        panel.classList.add("hidden");
        return;
      }
      panel.classList.remove("hidden");
      title.textContent = `${configWorkout} – ${workouts[configWorkout].nome || ""}`;

      const exs = workouts[configWorkout].exercises || [];
      if (!exs.length) {
        list.innerHTML = "<p class='text-xs text-slate-500'>Nenhum exercício neste treino.</p>";
        return;
      }

      list.innerHTML = exs.map((ex, idx) => `
        <div class="border rounded px-2 py-1 bg-white flex justify-between items-center">
          <div class="text-xs">
            <p class="font-medium">${ex.name}</p>
            <p class="text-slate-500">Reps: ${ex.reps}</p>
            ${ex.gif ? `<p class="text-emerald-600">Vídeo cadastrado</p>` : "<p class='text-slate-400'>Sem vídeo</p>"}
          </div>
          <div class="flex gap-2">
            <button class="text-xs text-blue-600" onclick="startEditExercise(${idx})">
              Editar
            </button>
            <button class="text-xs text-red-600" onclick="removeExercise(${idx})">
              Remover
            </button>
          </div>
        </div>
      `).join("");
    }

    function resetConfigFormUI() {
      document.getElementById("cfg-name").value = "";
      document.getElementById("cfg-reps").value = "";
      document.getElementById("cfg-gif").value = "";
      document.getElementById("cfg-template").value = "";
      editExerciseIndex = null;
      document.getElementById("cfg-form-title").textContent = "Adicionar exercício";
      document.getElementById("cfg-add-btn").textContent = "Adicionar exercício";
      document.getElementById("cfg-cancel-edit-btn").classList.add("hidden");
    }

    function startEditExercise(index) {
      if (!configWorkout) return;
      const ex = workouts[configWorkout].exercises[index];
      document.getElementById("cfg-name").value = ex.name;
      document.getElementById("cfg-reps").value = ex.reps;
      document.getElementById("cfg-gif").value = ex.gif || "";
      document.getElementById("cfg-template").value = "";
      editExerciseIndex = index;

      document.getElementById("cfg-form-title").textContent = "Editar exercício";
      document.getElementById("cfg-add-btn").textContent = "Salvar edição";
      document.getElementById("cfg-cancel-edit-btn").classList.remove("hidden");
    }

    function cancelEditExercise() {
      resetConfigFormUI();
    }

    function submitExerciseConfig() {
      if (!configWorkout) return;
      const nameEl = document.getElementById("cfg-name");
      const repsEl = document.getElementById("cfg-reps");
      const gifEl = document.getElementById("cfg-gif");

      const name = nameEl.value.trim();
      const reps = repsEl.value.trim();
      const gif = gifEl.value.trim();

      if (!name || !reps) {
        alert("Nome e séries/reps são obrigatórios.");
        return;
      }

      if (!workouts[configWorkout].exercises) {
        workouts[configWorkout].exercises = [];
      }

      if (editExerciseIndex !== null) {
        workouts[configWorkout].exercises[editExerciseIndex] = { name, reps, gif };
      } else {
        workouts[configWorkout].exercises.push({ name, reps, gif });
      }

      saveWorkouts();
      resetConfigFormUI();
      renderConfigPanel();
      renderWorkoutButtons();
      if (selectedWorkout === configWorkout) renderExerciseList();
      fillExerciseSelect();
    }

    function removeExercise(index) {
      if (!configWorkout) return;
      workouts[configWorkout].exercises.splice(index, 1);
      saveWorkouts();
      resetConfigFormUI();
      renderConfigPanel();
      if (selectedWorkout === configWorkout) renderExerciseList();
      fillExerciseSelect();
    }

    function resetCurrentWorkoutToDefault() {
      if (!configWorkout) return;
      const defaults = cloneDefaultWorkouts();
      if (!defaults[configWorkout]) {
        alert("Não há padrão salvo para este treino (apenas A–E).");
        return;
      }
      if (!confirm(`Resetar o Treino ${configWorkout} para o padrão inicial?`)) return;
      workouts[configWorkout] = defaults[configWorkout];
      saveWorkouts();
      resetConfigFormUI();
      renderConfigPanel();
      renderWorkoutButtons();
      if (selectedWorkout === configWorkout) renderExerciseList();
      fillExerciseSelect();
    }

    function resetAllWorkouts() {
      if (!confirm("Resetar TODOS os treinos para o padrão inicial (A–E) e apagar treinos extras?")) return;
      workouts = cloneDefaultWorkouts();
      saveWorkouts();
      selectedWorkout = null;
      configWorkout = null;
      editExerciseIndex = null;
      resetConfigFormUI();
      renderConfigButtons();
      renderConfigPanel();
      renderWorkoutButtons();
      renderExerciseList();
      fillExerciseSelect();
    }

    function addWorkoutConfig() {
      const letterEl = document.getElementById("cfg-new-workout-letter");
      const nameEl = document.getElementById("cfg-new-workout-name");
      let letter = (letterEl.value || "").toUpperCase().trim();
      if (!letter) {
        alert("Informe uma letra para o treino (A, B, C...).");
        return;
      }
      if (!/^[A-Z]$/.test(letter)) {
        alert("Use apenas uma letra (A–Z) para o nome do treino.");
        return;
      }
      if (workouts[letter]) {
        alert("Esse treino já existe.");
        return;
      }
      const nome = nameEl.value.trim() || `Treino ${letter}`;
      workouts[letter] = { nome, exercises: [] };
      saveWorkouts();
      letterEl.value = "";
      nameEl.value = "";
      configWorkout = letter;
      editExerciseIndex = null;
      resetConfigFormUI();
      renderConfigButtons();
      renderConfigPanel();
      renderWorkoutButtons();
    }

    function deleteCurrentWorkout() {
      if (!configWorkout) return;
      const letter = configWorkout;
      if (!confirm(`Excluir definitivamente o Treino ${letter}? (Os registros antigos dele continuam no histórico)`)) return;
      delete workouts[letter];
      saveWorkouts();
      if (selectedWorkout === letter) {
        selectedWorkout = null;
        renderExerciseList();
      }
      configWorkout = null;
      editExerciseIndex = null;
      resetConfigFormUI();
      renderConfigButtons();
      renderConfigPanel();
      renderWorkoutButtons();
      fillExerciseSelect();
    }

    // ---------- Templates select ----------
    function fillExerciseTemplatesSelect() {
      const sel = document.getElementById("cfg-template");
      if (!sel) return;
      sel.innerHTML = '<option value="">-- escolher da lista --</option>';

      EXERCISE_TEMPLATES.forEach(tpl => {
        const opt = document.createElement("option");
        opt.value = tpl.id;
        opt.textContent = `${tpl.grupo} – ${tpl.name} (${tpl.reps})`;
        sel.appendChild(opt);
      });

      sel.onchange = () => {
        const id = sel.value;
        const tpl = EXERCISE_TEMPLATES.find(t => t.id === id);
        if (!tpl) return;
        document.getElementById("cfg-name").value = tpl.name;
        document.getElementById("cfg-reps").value = tpl.reps;
        document.getElementById("cfg-gif").value = tpl.url;
      };
    }

    // ---------- Init por usuário ----------
    function initAppForUser() {
      document.getElementById("today-date").textContent = formatBR(todayISO());
      renderWorkoutButtons();
      renderExerciseList();
      fillExerciseSelect();
      switchView("today");
    }

    // ---------- Init geral ----------
    (function init() {
      fillExerciseTemplatesSelect();
      refreshLoginUsersInfo();
    })();
    
  </script>
 <!-- Registro do Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("service-worker.js")
          .then(() => console.log("Service Worker registrado"))
          .catch(err => console.error("Erro no SW:", err));
      });
    }
  </script>
</body>
</html>
