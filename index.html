<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GymLog ‚Äì Treino & Alimenta√ß√£o</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#2563eb',
            secondary: '#10b981',
            bgDark: '#020617'
          }
        }
      }
    }
  </script>

  <!-- Chart.js para gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Scroll suave */
    html {
      scroll-behavior: smooth;
    }

    /* Modo foco: esconde elementos com .non-focus quando ativo */
    .focus-mode .non-focus {
      display: none !important;
    }

    /* Sele√ß√£o de emoji/mood */
    .mood-btn-active {
      transform: scale(1.15);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.4);
    }
  </style>
</head>

<body class="bg-slate-100 dark:bg-slate-900 min-h-screen flex flex-col items-center justify-center text-slate-900 dark:text-slate-100">

  <!-- TELA DE LOGIN -->
  <div id="login-screen" class="w-full max-w-md bg-white dark:bg-slate-800 shadow-lg rounded-xl m-3 p-4 space-y-4">
    <h1 class="text-xl font-bold text-slate-800 dark:text-slate-100 text-center">
      GymLog ‚Äì Acessos
    </h1>
    <p class="text-xs text-slate-500 dark:text-slate-300 text-center">
      Crie um usu√°rio local para salvar seus treinos e alimenta√ß√£o neste dispositivo.
    </p>

    <div class="space-y-2">
      <label class="text-sm font-medium block" for="login-username">Usu√°rio</label>
      <input id="login-username" type="text"
             class="w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded px-3 py-2 text-sm"
             placeholder="ex: Jo√£o/Maria" />
    </div>

    <div class="space-y-2">
      <label class="text-sm font-medium block" for="login-password">Senha</label>
      <input id="login-password" type="password"
             class="w-full border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded px-3 py-2 text-sm"
             placeholder="m√≠nimo 4 caracteres" />
    </div>

    <div class="flex flex-col sm:flex-row gap-2 mt-2">
      <button class="flex-1 bg-primary text-white text-sm py-2 rounded hover:bg-blue-700"
              onclick="handleLogin()">
        Entrar
      </button>
      <button class="flex-1 border border-primary text-primary text-sm py-2 rounded hover:bg-blue-50 dark:hover:bg-slate-700"
              onclick="handleRegister()">
        Criar conta
      </button>
    </div>

    <p id="login-msg" class="text-xs text-center text-red-500 h-4"></p>
  </div>

  <!-- APP PRINCIPAL -->
  <div id="app-screen" class="hidden w-full max-w-5xl bg-white dark:bg-slate-800 shadow-lg rounded-xl m-3 p-4 space-y-4">

    <!-- Cabe√ßalho -->
    <div class="flex flex-col sm:flex-row justify-between gap-3 items-start non-focus">
      <div>
        <h1 class="text-2xl font-bold text-slate-800 dark:text-slate-100">
          GymLog
        </h1>
        <p class="text-xs text-slate-500 dark:text-slate-300">
          Seu painel de treino + alimenta√ß√£o
        </p>
      </div>

      <div class="flex items-center gap-3 text-xs">
        <button id="theme-toggle"
                class="border border-slate-300 dark:border-slate-600 rounded px-2 py-1 flex items-center gap-1 hover:bg-slate-100 dark:hover:bg-slate-700">
          <span id="theme-icon">üåô</span>
          <span>Tema</span>
        </button>

        <div class="text-right">
          <div id="user-label" class="text-slate-500 dark:text-slate-300 mb-1"></div>
          <button class="border border-slate-300 dark:border-slate-600 px-2 py-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700"
                  onclick="logout()">
            Sair
          </button>
        </div>
      </div>
    </div>

    <!-- Navega√ß√£o principal (Home / Treino / Alimenta√ß√£o) -->
    <div class="non-focus">
      <div class="flex flex-wrap gap-2 text-sm border-b border-slate-200 dark:border-slate-700 pb-2">
        <button id="nav-home"
                class="px-3 py-1 rounded-full bg-primary text-white"
                onclick="setMainSection('home')">
          In√≠cio
        </button>
        <button id="nav-treino"
                class="px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700"
                onclick="setMainSection('treino')">
          Treino
        </button>
        <button id="nav-alimentacao"
                class="px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700"
                onclick="setMainSection('alimentacao')">
          Alimenta√ß√£o
        </button>
      </div>
    </div>

    <!-- HOME / MENU PRINCIPAL -->
    <div id="home-view" class="mt-4 space-y-4">
      <p class="text-sm text-slate-600 dark:text-slate-200">
        Escolha o que deseja acompanhar agora:
      </p>
      <div class="grid md:grid-cols-2 gap-4">
        <button onclick="setMainSection('treino')"
                class="w-full border border-blue-200 dark:border-blue-500/40 rounded-xl p-4 flex flex-col items-start gap-2 hover:bg-blue-50 dark:hover:bg-slate-700">
          <div class="text-3xl">üèãÔ∏è‚Äç‚ôÇÔ∏è</div>
          <div class="font-semibold text-slate-800 dark:text-slate-100">Treino</div>
          <p class="text-xs text-slate-500 dark:text-slate-300">
            Registrar cargas, cardio, tempo de treino, sensa√ß√£o do dia e ver evolu√ß√£o.
          </p>
        </button>

        <button onclick="setMainSection('alimentacao')"
                class="w-full border border-emerald-200 dark:border-emerald-500/40 rounded-xl p-4 flex flex-col items-start gap-2 hover:bg-emerald-50 dark:hover:bg-slate-700">
          <div class="text-3xl">üçΩÔ∏è</div>
          <div class="font-semibold text-slate-800 dark:text-slate-100">Alimenta√ß√£o</div>
          <p class="text-xs text-slate-500 dark:text-slate-300">
            Calcular meta de kcal, registrar refei√ß√µes e ver o balan√ßo do dia.
          </p>
        </button>
      </div>
    </div>

    <!-- M√ìDULO TREINO -->
    <div id="treino-view" class="hidden mt-4 space-y-4">

      <!-- Tabs internas do m√≥dulo de treino -->
      <div class="flex flex-wrap gap-2 text-sm border-b border-slate-200 dark:border-slate-700 pb-2 non-focus">
        <button id="tab-today"
                class="px-3 py-1 rounded-full bg-primary text-white"
                onclick="switchTreinoTab('today')">
          Treino de hoje
        </button>
        <button id="tab-calendar"
                class="px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700"
                onclick="switchTreinoTab('calendar')">
          Calend√°rio
        </button>
        <button id="tab-progress"
                class="px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700"
                onclick="switchTreinoTab('progress')">
          Progresso
        </button>
        <button id="tab-config"
                class="px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700"
                onclick="switchTreinoTab('config')">
          Configurar treinos
        </button>
      </div>

      <!-- TREINO DE HOJE -->
      <section id="view-today" class="space-y-4">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-2">
          <p class="text-sm text-slate-600 dark:text-slate-200">
            Hoje: <span id="today-date" class="font-semibold"></span>
          </p>

          <div class="flex items-center gap-2 text-xs non-focus">
            <button id="focus-toggle"
                    class="border border-slate-300 dark:border-slate-600 rounded px-2 py-1 hover:bg-slate-100 dark:hover:bg-slate-700"
                    onclick="toggleFocusMode()">
              Modo foco
            </button>
          </div>
        </div>

        <!-- Tempo e sensa√ß√£o -->
        <div class="grid md:grid-cols-2 gap-3">
          <div class="border border-slate-200 dark:border-slate-700 rounded-lg p-3 space-y-2">
            <p class="text-sm font-semibold">Tempo de treino</p>
            <div class="flex items-center justify-between gap-2">
              <div class="text-2xl font-mono" id="timer-display">00:00</div>
              <div class="flex flex-col gap-1 text-xs">
                <div class="flex gap-1">
                  <button class="flex-1 bg-primary text-white rounded px-2 py-1"
                          onclick="startTimer()">Iniciar</button>
                  <button class="flex-1 bg-slate-200 dark:bg-slate-700 rounded px-2 py-1"
                          onclick="stopTimer()">Pausar</button>
                </div>
                <button class="bg-slate-100 dark:bg-slate-700 rounded px-2 py-1"
                        onclick="resetTimer()">Zerar</button>
              </div>
            </div>
            <div class="mt-2 text-xs">
              <label class="block mb-1" for="total-time-input">Tempo total (min) ‚Äì voc√™ pode editar manualmente</label>
              <input id="total-time-input" type="number" min="0"
                     class="w-full border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700 text-sm" />
            </div>
          </div>

          <div class="border border-slate-200 dark:border-slate-700 rounded-lg p-3 space-y-2">
            <p class="text-sm font-semibold">Como estou hoje</p>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div>
                <label class="block mb-1">Sono</label>
                <select id="sleep-input"
                        class="w-full border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700 text-sm">
                  <option value="0">N√£o informar</option>
                  <option value="1">Muito ruim</option>
                  <option value="2">Ruim</option>
                  <option value="3">Ok</option>
                  <option value="4">Bom</option>
                  <option value="5">Excelente</option>
                </select>
              </div>
              <div>
                <label class="block mb-1">Energia</label>
                <select id="energy-input"
                        class="w-full border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700 text-sm">
                  <option value="0">N√£o informar</option>
                  <option value="1">Zerado</option>
                  <option value="2">Baixo</option>
                  <option value="3">M√©dio</option>
                  <option value="4">Alto</option>
                  <option value="5">Estou voando</option>
                </select>
              </div>
            </div>
            <div class="mt-2 text-xs">
              <p class="mb-1">Humor / disposi√ß√£o</p>
              <div class="flex gap-2">
                <button class="mood-btn text-xl" data-mood="üíÄ" onclick="selectMood(this)">üíÄ</button>
                <button class="mood-btn text-xl" data-mood="üò¥" onclick="selectMood(this)">üò¥</button>
                <button class="mood-btn text-xl" data-mood="üòê" onclick="selectMood(this)">üòê</button>
                <button class="mood-btn text-xl" data-mood="üôÇ" onclick="selectMood(this)">üôÇ</button>
                <button class="mood-btn text-xl" data-mood="üî•" onclick="selectMood(this)">üî•</button>
              </div>
              <input type="hidden" id="mood-input" value="">
            </div>
          </div>
        </div>

        <!-- Cardio -->
        <div class="border border-slate-200 dark:border-slate-700 rounded-lg p-3 space-y-2">
          <div class="flex items-center justify-between gap-2">
            <p class="text-sm font-semibold">Cardio do dia</p>
            <span class="text-xs text-slate-500 dark:text-slate-300">Esteira, bike, escada, corrida...</span>
          </div>
          <div class="grid md:grid-cols-4 gap-2 text-xs">
            <select id="cardio-type"
                    class="border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700">
              <option value="Esteira">Esteira</option>
              <option value="Bike">Bike</option>
              <option value="Escada">Escada</option>
              <option value="Corrida">Corrida rua</option>
              <option value="El√≠ptico">El√≠ptico</option>
              <option value="Outro">Outro</option>
            </select>
            <input id="cardio-minutes" type="number" min="0" placeholder="Minutos"
                   class="border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700" />
            <input id="cardio-distance" type="number" min="0" step="0.1" placeholder="Km (opcional)"
                   class="border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700" />
            <select id="cardio-intensity"
                    class="border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700">
              <option value="leve">Leve</option>
              <option value="moderado">Moderado</option>
              <option value="forte">Forte</option>
            </select>
          </div>
          <div class="mt-2 flex justify-end">
            <button class="text-xs bg-secondary text-white rounded px-3 py-1"
                    onclick="addCardioEntry()">Adicionar cardio</button>
          </div>
          <div id="cardio-list" class="mt-2 text-xs space-y-1">
            <p class="text-slate-500 dark:text-slate-300 italic">
              Nenhum cardio registrado ainda.
            </p>
          </div>
        </div>

        <!-- Sele√ß√£o de treino -->
        <div>
          <p class="text-sm font-medium mb-1">Selecione o treino do dia:</p>
          <div id="workout-buttons" class="flex gap-2 flex-wrap">
            <!-- Bot√µes din√¢micos -->
          </div>
        </div>

        <!-- Lista de exerc√≠cios -->
        <div id="exercise-list" class="space-y-3">
          <p class="text-slate-500 dark:text-slate-300 text-sm italic">
            Escolha um treino para ver os exerc√≠cios.
          </p>
        </div>

        <button id="save-today-btn"
                class="hidden w-full bg-secondary text-white font-semibold py-2 rounded-lg hover:bg-emerald-700 text-sm"
                onclick="saveToday()">
          Salvar treino de hoje
        </button>

        <p id="today-msg" class="text-xs text-center text-slate-500 dark:text-slate-300"></p>
      </section>

      <!-- CALEND√ÅRIO -->
      <section id="view-calendar" class="space-y-4 hidden">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-2">
          <div class="flex items-center gap-2">
            <button class="p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700"
                    onclick="changeMonth(-1)">&#9664;</button>
            <p id="month-label" class="font-semibold"></p>
            <button class="p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700"
                    onclick="changeMonth(1)">&#9654;</button>
          </div>
          <div class="text-xs flex items-center gap-2">
            <span>Filtrar por treino:</span>
            <select id="calendar-filter"
                    class="border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700"
                    onchange="renderCalendar()">
              <option value="">Todos</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
              <option value="E">E</option>
              <option value="F">F</option>
              <option value="G">G</option>
              <option value="H">H</option>
              <option value="I">I</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-7 text-center text-xs font-medium text-slate-500 dark:text-slate-300">
          <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>S√°b</div>
        </div>

        <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-xs"></div>

        <div id="day-details" class="hidden border border-slate-200 dark:border-slate-700 rounded-lg p-3 space-y-2">
          <div class="flex justify-between items-center">
            <p id="day-details-title" class="font-semibold mb-1"></p>
            <button class="text-xs text-red-600 underline"
                    onclick="deleteDayLogs()">
              Excluir todos registros deste dia
            </button>
          </div>
          <div id="day-details-body" class="space-y-1 text-sm"></div>
        </div>

        <!-- Resumo do m√™s -->
        <div class="border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-xs space-y-1">
          <p class="font-semibold mb-1">Resumo do m√™s</p>
          <div id="month-summary" class="space-y-1 text-slate-600 dark:text-slate-200">
            <!-- preenchido via JS -->
          </div>
        </div>
      </section>

      <!-- PROGRESSO / EVOLU√á√ÉO -->
      <section id="view-progress" class="space-y-4 hidden">
        <div>
          <label class="text-sm font-medium block mb-1">Escolha um exerc√≠cio:</label>
          <select id="exercise-select"
                  class="w-full border border-slate-300 dark:border-slate-600 rounded-lg p-2 text-sm bg-white dark:bg-slate-700"
                  onchange="renderExerciseHistoryChart()">
            <option value="">-- selecione --</option>
          </select>
        </div>

        <div class="border border-slate-200 dark:border-slate-700 rounded-lg p-3">
          <p class="text-sm font-semibold mb-2">Evolu√ß√£o da carga</p>
          <canvas id="exercise-chart" height="200"></canvas>
        </div>

        <div id="exercise-history" class="space-y-2 text-sm">
          <p class="text-slate-500 dark:text-slate-300 italic text-sm">
            Selecione um exerc√≠cio para ver a evolu√ß√£o da carga.
          </p>
        </div>
      </section>

      <!-- CONFIGURAR TREINOS -->
      <section id="view-config" class="space-y-4 hidden">
        <p class="text-sm text-slate-600 dark:text-slate-200">
          Aqui voc√™ pode criar treinos (A, B, C...) e adicionar/remover/editar exerc√≠cios.
          Tamb√©m √© poss√≠vel marcar alguns como favoritos.
        </p>

        <!-- Sele√ß√£o de treino -->
        <div class="flex flex-wrap gap-2 text-sm">
          <div id="config-workout-buttons" class="flex flex-wrap gap-2">
            <!-- Bot√µes din√¢micos -->
          </div>
          <button class="text-xs border border-slate-300 dark:border-slate-600 rounded px-2 py-1 hover:bg-slate-100 dark:hover:bg-slate-700"
                  onclick="promptAddWorkout()">
            + Novo treino
          </button>
        </div>

        <!-- Painel configura√ß√£o -->
        <div id="config-panel" class="border border-slate-200 dark:border-slate-700 rounded-lg p-3 space-y-3">
          <p class="text-sm text-slate-500 dark:text-slate-300">
            Selecione um treino para editar.
          </p>
        </div>
      </section>

    </div>

    <!-- M√ìDULO ALIMENTA√á√ÉO -->
    <div id="alimentacao-view" class="hidden mt-4 space-y-4">

      <!-- Tabs alimenta√ß√£o -->
      <div class="flex flex-wrap gap-2 text-sm border-b border-slate-200 dark:border-slate-700 pb-2 non-focus">
        <button id="tab-nutri-profile"
                class="px-3 py-1 rounded-full bg-primary text-white"
                onclick="switchNutriTab('profile')">
          Perfil & Meta
        </button>
        <button id="tab-nutri-diary"
                class="px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700"
                onclick="switchNutriTab('diary')">
          Di√°rio alimentar
        </button>
        <button id="tab-nutri-summary"
                class="px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700"
                onclick="switchNutriTab('summary')">
          Resumo & Gr√°fico
        </button>
      </div>

      <!-- PERFIL -->
      <section id="nutri-profile" class="space-y-4">
        <p class="text-sm text-slate-600 dark:text-slate-200">
          Preencha seus dados para estimar a meta di√°ria de calorias.
        </p>

        <div class="grid md:grid-cols-3 gap-3 text-sm">
          <div>
            <label class="block mb-1">Sexo</label>
            <select id="nutri-sex"
                    class="w-full border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700">
              <option value="M">Masculino</option>
              <option value="F">Feminino</option>
            </select>
          </div>
          <div>
            <label class="block mb-1">Idade (anos)</label>
            <input id="nutri-age" type="number" min="10" max="100"
                   class="w-full border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700" />
          </div>
          <div>
            <label class="block mb-1">Altura (cm)</label>
            <input id="nutri-height" type="number" min="120" max="220"
                   class="w-full border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700" />
          </div>
          <div>
            <label class="block mb-1">Peso (kg)</label>
            <input id="nutri-weight" type="number" min="30" max="250" step="0.1"
                   class="w-full border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700" />
          </div>
          <div>
            <label class="block mb-1">Atividade do dia</label>
            <select id="nutri-activity"
                    class="w-full border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700">
              <option value="1.2">Sedent√°rio</option>
              <option value="1.375">Levemente ativo</option>
              <option value="1.55">Moderadamente ativo</option>
              <option value="1.725">Muito ativo</option>
              <option value="1.9">Extremamente ativo</option>
            </select>
          </div>
          <div>
            <label class="block mb-1">Objetivo</label>
            <select id="nutri-goal"
                    class="w-full border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700">
              <option value="cut">Emagrecer</option>
              <option value="maintain">Manter</option>
              <option value="bulk">Ganhar massa magra</option>
            </select>
          </div>
        </div>

        <div class="flex justify-end">
          <button class="bg-secondary text-white text-sm rounded px-4 py-2 hover:bg-emerald-700"
                  onclick="saveNutritionProfile()">
            Calcular & salvar perfil
          </button>
        </div>

        <div id="nutri-result" class="border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-sm space-y-1">
          <p class="text-slate-500 dark:text-slate-300">
            Ap√≥s salvar o perfil, a meta di√°ria aparecer√° aqui.
          </p>
        </div>
      </section>

      <!-- DI√ÅRIO ALIMENTAR -->
      <div class="border border-slate-200 dark:border-slate-700 rounded-lg p-3 space-y-2 text-sm">
  <p class="font-semibold">Registrar refei√ß√£o</p>

  <!-- Campo de data do di√°rio alimentar -->
  <div class="text-xs mb-2">
    <label class="block mb-1">Dia</label>
    <input id="meal-date" type="date"
           class="border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700"
           onchange="renderMealsForDate(this.value)">
  </div>

  <div class="grid md:grid-cols-4 gap-2 text-xs">
    <!-- Tipo de refei√ß√£o (mantido) -->
    <select id="meal-type"
            class="border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700">
      <option value="Caf√© da manh√£">Caf√© da manh√£</option>
      <option value="Lanche da manh√£">Lanche da manh√£</option>
      <option value="Almo√ßo">Almo√ßo</option>
      <option value="Lanche da tarde">Lanche da tarde</option>
      <option value="Jantar">Jantar</option>
      <option value="Ceia">Ceia</option>
      <option value="Outro">Outro</option>
    </select>

    <!-- NOVO: menu suspenso com alimentos -->
    <select id="meal-food"
            class="border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700"
            onchange="onMealFoodChange()">
      <!-- op√ß√µes ser√£o preenchidas pelo JS (populateFoodOptions) -->
    </select>

    <!-- Descri√ß√£o preenchida automaticamente pelo alimento escolhido -->
    <input id="meal-desc" type="text" placeholder="Ser√° preenchido pelo alimento"
           class="border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700"
           readonly />

    <!-- Kcal estimada (auto-preenchida, mas edit√°vel para ajuste fino) -->
    <input id="meal-kcal" type="number" min="0" placeholder="Kcal estimada"
           class="border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700" />

    <!-- Como temos 4 colunas na grid, o bot√£o vem embaixo ocupando tudo em telas pequenas -->
    <div class="md:col-span-4 flex justify-end mt-1">
      <button class="bg-secondary text-white rounded px-3 py-1 hover:bg-emerald-700"
              onclick="addMeal()">
        Adicionar
      </button>
    </div>
  </div>
</div>

        <div id="meal-summary" class="border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-xs space-y-2">
          <!-- resumo do dia -->
        </div>

        <div id="meal-list" class="space-y-2 text-xs">
          <!-- lista de refei√ß√µes -->
        </div>
      </section>

      <!-- RESUMO & GR√ÅFICO -->
      <section id="nutri-summary" class="space-y-4 hidden">
        <p class="text-sm text-slate-600 dark:text-slate-200">
          Vis√£o geral unindo alimenta√ß√£o, treino e cardio (√∫ltimos 14 dias).
        </p>

        <div class="border border-slate-200 dark:border-slate-700 rounded-lg p-3">
          <canvas id="summary-chart" height="220"></canvas>
        </div>

        <div id="summary-extra" class="text-xs text-slate-600 dark:text-slate-200 space-y-1">
          <!-- textos auxiliares -->
        </div>
      </section>

    </div>

  </div>

  <!-- JS -->
  <script>
    // ---------- CONSTANTES / KEYS ----------
    const USERS_KEY = "gymlog-users-v1";
    const CURRENT_USER_KEY = "gymlog-current-user-v1";
    const LOGS_KEY_BASE = "gymlog-registros-v2-";
    const WORKOUTS_KEY_BASE = "gymlog-workouts-v2-";
    const SESSIONS_KEY_BASE = "gymlog-sessoes-v1-";
    const NUTRI_PROFILE_KEY_BASE = "gymlog-nutri-profile-v1-";
    const MEALS_KEY_BASE = "gymlog-meals-v1-";
    const THEME_KEY = "gymlog-theme";

    let currentUser = null;
    let logs = [];       // registros por exerc√≠cio
    let workouts = {};   // defini√ß√£o dos treinos
    let sessions = [];   // sess√£o por dia+treino
    let nutritionProfile = null;
    let meals = [];
    let selectedWorkout = null;
    let currentMonth = new Date();
    let lastDayDetailsDate = null;
    
    // Lista b√°sica de alimentos
const FOOD_ITEMS = [
  { label: "2 ovos + 1 p√£o franc√™s", kcal: 320 },
  { label: "2 ovos mexidos", kcal: 160 },
  { label: "1 p√£o franc√™s", kcal: 150 },
  { label: "100 g frango grelhado", kcal: 165 },
  { label: "150 g frango grelhado", kcal: 250 },
  { label: "100 g carne mo√≠da", kcal: 250 },
  { label: "100 g arroz cozido", kcal: 130 },
  { label: "100 g feij√£o cozido", kcal: 80 },
  { label: "1 banana m√©dia", kcal: 90 },
  { label: "1 colher de sopa requeij√£o", kcal: 60 },
  { label: "1 colher de sopa aveia (~15 g)", kcal: 55 },
  { label: "1 colher de sopa mel", kcal: 60 },
  { label: "1 scoop whey (30 g)", kcal: 110 },
];

// Preenche o menu suspenso de alimentos
function populateFoodOptions() {
  const select = document.getElementById("meal-food");
  if (!select) return;

  // Limpa op√ß√µes
  select.innerHTML = "";

  // Placeholder
  const placeholder = document.createElement("option");
  placeholder.value = "";
  placeholder.textContent = "Selecione o alimento";
  placeholder.disabled = true;
  placeholder.selected = true;
  select.appendChild(placeholder);

  // Op√ß√µes vindas da tabela
  FOOD_ITEMS.forEach((item, idx) => {
    const opt = document.createElement("option");
    opt.value = String(idx); // √≠ndice do array
    opt.textContent = `${item.label} (~${item.kcal} kcal)`;
    select.appendChild(opt);
  });

  // Op√ß√£o para alimento personalizado
  const customOpt = document.createElement("option");
  customOpt.value = "custom";
  customOpt.textContent = "Outro alimento (preencher manualmente)";
  select.appendChild(customOpt);
}

// Quando o usu√°rio troca o alimento no select
function onMealFoodChange() {
  const select = document.getElementById("meal-food");
  const descInput = document.getElementById("meal-desc");
  const kcalInput = document.getElementById("meal-kcal");
  if (!select || !descInput || !kcalInput) return;

  const value = select.value;

  // Nada selecionado
  if (!value) {
    descInput.value = "";
    kcalInput.value = "";
    descInput.readOnly = true;
    return;
  }

  // Op√ß√£o "Outro alimento"
  if (value === "custom") {
    descInput.value = "";
    kcalInput.value = "";
    descInput.readOnly = false;   // pode digitar o que comeu
    kcalInput.readOnly = false;   // e colocar a kcal manual
    descInput.focus();
    return;
  }

  // Uma op√ß√£o padr√£o
  const index = parseInt(value, 10);
  const item = FOOD_ITEMS[index];
  if (!item) return;

  descInput.readOnly = true;      // travamos a descri√ß√£o para bater com o item
  descInput.value = item.label;
  kcalInput.readOnly = false;     // kcal pode ser ajustada se a por√ß√£o for diferente
  kcalInput.value = item.kcal;
}

// Inicializa√ß√£o do di√°rio
function initNutritionDiary() {
  // Sempre preenche o menu de alimentos
  populateFoodOptions();

  // Se existir um campo de data, usa para o di√°rio
  const dateInput = document.getElementById("meal-date");
  if (dateInput) {
    dateInput.value = todayISO();
    renderMealsForDate(dateInput.value);
  }
}

    

    // Timer treino de hoje
    let timerInterval = null;
    let timerStart = null;
    let timerAccumulatedMs = 0;

    // Cardio do dia (mem√≥ria s√≥ da tela; salvo ao salvar treino)
    let currentCardioEntries = [];

    // Charts
    let exerciseChart = null;
    let summaryChart = null;

    // ---------- FUN√á√ïES UTIL ----------

    function todayISO() {
      return new Date().toISOString().slice(0, 10);
    }

    function fmtDateBR(iso) {
      if (!iso) return "";
      const [y, m, d] = iso.split("-");
      return `${d}/${m}/${y}`;
    }

    function loadJSON(key, fallback) {
      try {
        const data = JSON.parse(localStorage.getItem(key));
        return data ?? fallback;
      } catch {
        return fallback;
      }
    }

    function saveJSON(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    function getUserKey(base) {
      if (!currentUser) return null;
      return base + currentUser;
    }

    function showLoginMsg(text, isError = true) {
      const el = document.getElementById("login-msg");
      el.textContent = text || "";
      el.classList.remove("text-red-500", "text-emerald-600");
      el.classList.add(isError ? "text-red-500" : "text-emerald-600");
    }

    function showTodayMsg(text) {
      document.getElementById("today-msg").textContent = text || "";
    }

    // ---------- LOGIN / USU√ÅRIOS ----------

    function loadUsers() {
      return loadJSON(USERS_KEY, {});
    }

    function saveUsers(users) {
      saveJSON(USERS_KEY, users);
    }

    function handleLogin() {
      const username = document.getElementById("login-username").value.trim();
      const password = document.getElementById("login-password").value;

      if (!username || !password) {
        showLoginMsg("Preencha usu√°rio e senha.");
        return;
      }
      const users = loadUsers();
      if (!users[username]) {
        showLoginMsg("Usu√°rio n√£o encontrado.");
        return;
      }
      if (users[username].password !== password) {
        showLoginMsg("Senha incorreta.");
        return;
      }
      currentUser = username;
      localStorage.setItem(CURRENT_USER_KEY, currentUser);
      showLoginMsg("");
      enterApp();
    }

    function handleRegister() {
      const username = document.getElementById("login-username").value.trim();
      const password = document.getElementById("login-password").value;

      if (!username || !password) {
        showLoginMsg("Preencha usu√°rio e senha para registrar.");
        return;
      }
      if (password.length < 4) {
        showLoginMsg("Senha deve ter pelo menos 4 caracteres.");
        return;
      }
      const users = loadUsers();
      if (users[username]) {
        showLoginMsg("Usu√°rio j√° existe, fa√ßa login.");
        return;
      }
      users[username] = { password };
      saveUsers(users);
      showLoginMsg("Usu√°rio criado, agora fa√ßa login.", false);
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem(CURRENT_USER_KEY);
      document.getElementById("app-screen").classList.add("hidden");
      document.getElementById("login-screen").classList.remove("hidden");
    }

    // ---------- INICIALIZA√á√ÉO APP ----------

    function cloneDefaultWorkouts() {
      // Fun√ß√£o placeholder gerando URL "gen√©rica" de demonstra√ß√£o (YouTube search)
      const demoUrl = (nome) =>
        "https://www.youtube.com/results?search_query=" + encodeURIComponent(nome + " exerc√≠cio academia");

      const DEFAULT_WORKOUTS = {
        A: {
          nome: "Treino A (Perna / Quadr√≠ceps / Gl√∫teo)",
          exercises: [
            { name: "Agachamento no smith", reps: "4x10-12", gif: demoUrl("Agachamento no smith"), favorite: false },
            { name: "Leg 45¬∫", reps: "4x10-12", gif: demoUrl("Leg 45"), favorite: false },
            { name: "Afundo com halteres", reps: "3x10 cada perna", gif: demoUrl("Afundo com halteres"), favorite: false },
            { name: "Cadeira extensora", reps: "4x12-15", gif: demoUrl("Cadeira extensora"), favorite: false },
            { name: "Adutora m√°quina", reps: "4x12-15", gif: demoUrl("Adutora m√°quina"), favorite: false },
            { name: "Panturrilha em p√©", reps: "4x15-20", gif: demoUrl("Panturrilha em p√© m√°quina"), favorite: false },
          ]
        },
        B: {
          nome: "Treino B (Costas / B√≠ceps)",
          exercises: [
            { name: "Puxada frente barra aberta", reps: "4x10-12", gif: demoUrl("Puxada frente barra aberta"), favorite: false },
            { name: "Remada baixa", reps: "4x10-12", gif: demoUrl("Remada baixa polia"), favorite: false },
            { name: "Remada cavalinho", reps: "4x10-12", gif: demoUrl("Remada cavalinho"), favorite: false },
            { name: "Rosca direta barra", reps: "3x8-10", gif: demoUrl("Rosca direta barra"), favorite: false },
            { name: "Rosca martelo", reps: "3x10-12", gif: demoUrl("Rosca martelo"), favorite: false },
            { name: "Face pull", reps: "3x12-15", gif: demoUrl("Face pull"), favorite: false },
          ]
        },
        C: {
          nome: "Treino C (Posterior / Gl√∫teo)",
          exercises: [
            { name: "Agachamento sum√¥ com halteres", reps: "4x10-12", gif: demoUrl("Agachamento sum√¥ halteres"), favorite: false },
            { name: "Mesa flexora", reps: "4x10-12", gif: demoUrl("Mesa flexora"), favorite: false },
            { name: "Cadeira flexora", reps: "4x10-12", gif: demoUrl("Cadeira flexora"), favorite: false },
            { name: "Eleva√ß√£o p√©lvica", reps: "4x10-12", gif: demoUrl("Eleva√ß√£o p√©lvica"), favorite: false },
            { name: "Cadeira abdutora", reps: "4x12-15", gif: demoUrl("Cadeira abdutora"), favorite: false },
          ]
        },
        D: {
          nome: "Treino D (Peito / Ombro / Tr√≠ceps)",
          exercises: [
            { name: "Supino reto m√°quina", reps: "4x10-12", gif: demoUrl("Supino reto m√°quina"), favorite: false },
            { name: "Supino inclinado m√°quina", reps: "3x10-12", gif: demoUrl("Supino inclinado m√°quina"), favorite: false },
            { name: "Fly peck deck", reps: "3x12-15", gif: demoUrl("Fly peck deck"), favorite: false },
            { name: "Tr√≠ceps corda", reps: "3x10-12", gif: demoUrl("Tr√≠ceps corda"), favorite: false },
            { name: "Eleva√ß√£o lateral", reps: "3x12-15", gif: demoUrl("Eleva√ß√£o lateral halteres"), favorite: false },
          ]
        },
        E: {
          nome: "Treino E (Perna 2 / Gl√∫teo)",
          exercises: [
            { name: "Agachamento livre", reps: "4x8-10", gif: demoUrl("Agachamento livre barra"), favorite: false },
            { name: "Leg 45¬∫", reps: "4x10-12", gif: demoUrl("Leg 45"), favorite: false },
            { name: "Stiff", reps: "4x8-10", gif: demoUrl("Stiff barra"), favorite: false },
            { name: "Mesa flexora", reps: "3x10-12", gif: demoUrl("Mesa flexora"), favorite: false },
            { name: "Eleva√ß√£o p√©lvica", reps: "3x10-12", gif: demoUrl("Eleva√ß√£o p√©lvica"), favorite: false },
          ]
        }
      };

      return JSON.parse(JSON.stringify(DEFAULT_WORKOUTS));
    }

    function enterApp() {
      document.getElementById("login-screen").classList.add("hidden");
      document.getElementById("app-screen").classList.remove("hidden");

      document.getElementById("user-label").textContent =
        "Usu√°rio: " + (currentUser || "");

      // carregar dados do usu√°rio
      logs = loadJSON(getUserKey(LOGS_KEY_BASE), []);
      workouts = loadJSON(getUserKey(WORKOUTS_KEY_BASE), null);
      sessions = loadJSON(getUserKey(SESSIONS_KEY_BASE), []);
      nutritionProfile = loadJSON(getUserKey(NUTRI_PROFILE_KEY_BASE), null);
      meals = loadJSON(getUserKey(MEALS_KEY_BASE), []);

      if (!workouts) {
        workouts = cloneDefaultWorkouts();
        saveJSON(getUserKey(WORKOUTS_KEY_BASE), workouts);
      }

      // Hoje
      document.getElementById("today-date").textContent = fmtDateBR(todayISO());

      // Preenche UI inicial
      selectedWorkout = null;
      currentCardioEntries = [];
      renderWorkoutButtons();
      renderTodayView();
      renderCalendar();
      fillExerciseSelect();
      renderConfigButtons();
      renderConfigPanel();
      renderNutritionProfileUI();
      initNutritionDiary();
      renderSummaryChart();

      // Se vier do login, come√ßa na home
      setMainSection("home");
    }

    // ---------- TEMA (DARK / LIGHT) ----------

    function applyTheme(theme) {
      const root = document.documentElement;
      if (theme === "dark") {
        root.classList.add("dark");
        document.getElementById("theme-icon").textContent = "‚òÄÔ∏è";
      } else {
        root.classList.remove("dark");
        document.getElementById("theme-icon").textContent = "üåô";
      }
    }

    function initTheme() {
      const stored = localStorage.getItem(THEME_KEY) || "light";
      applyTheme(stored);
    }

    function toggleTheme() {
      const root = document.documentElement;
      const isDark = root.classList.contains("dark");
      const newTheme = isDark ? "light" : "dark";
      localStorage.setItem(THEME_KEY, newTheme);
      applyTheme(newTheme);
    }

    // ---------- NAVEGA√á√ÉO PRINCIPAL ----------

    function setMainSection(section) {
      const homeView = document.getElementById("home-view");
      const treinoView = document.getElementById("treino-view");
      const aliView = document.getElementById("alimentacao-view");

      homeView.classList.add("hidden");
      treinoView.classList.add("hidden");
      aliView.classList.add("hidden");

      document.getElementById("nav-home").className =
        "px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700";
      document.getElementById("nav-treino").className =
        "px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700";
      document.getElementById("nav-alimentacao").className =
        "px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700";

      if (section === "home") {
        homeView.classList.remove("hidden");
        document.getElementById("nav-home").className =
          "px-3 py-1 rounded-full bg-primary text-white";
      } else if (section === "treino") {
        treinoView.classList.remove("hidden");
        document.getElementById("nav-treino").className =
          "px-3 py-1 rounded-full bg-primary text-white";
      } else {
        aliView.classList.remove("hidden");
        document.getElementById("nav-alimentacao").className =
          "px-3 py-1 rounded-full bg-primary text-white";
      }
    }

    // ---------- MODO FOCO ----------

    function toggleFocusMode() {
      document.body.classList.toggle("focus-mode");
    }

    // ---------- TREINO: TABS INTERNAS ----------

    function switchTreinoTab(tab) {
      const ids = ["view-today", "view-calendar", "view-progress", "view-config"];
      ids.forEach(id => document.getElementById(id).classList.add("hidden"));

      if (tab === "today") {
        document.getElementById("view-today").classList.remove("hidden");
      } else if (tab === "calendar") {
        document.getElementById("view-calendar").classList.remove("hidden");
        renderCalendar();
      } else if (tab === "progress") {
        document.getElementById("view-progress").classList.remove("hidden");
        fillExerciseSelect();
        renderExerciseHistoryChart();
      } else {
        document.getElementById("view-config").classList.remove("hidden");
        renderConfigButtons();
        renderConfigPanel();
      }

      document.getElementById("tab-today").className =
        "px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700";
      document.getElementById("tab-calendar").className =
        "px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700";
      document.getElementById("tab-progress").className =
        "px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700";
      document.getElementById("tab-config").className =
        "px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700";

      document.getElementById("tab-" + tab).className =
        "px-3 py-1 rounded-full bg-primary text-white";
    }

    // ---------- TREINO: TIMER ----------

    function updateTimerDisplay() {
      const totalMs = timerAccumulatedMs + (timerStart ? (Date.now() - timerStart) : 0);
      const totalSec = Math.floor(totalMs / 1000);
      const min = String(Math.floor(totalSec / 60)).padStart(2, "0");
      const sec = String(totalSec % 60).padStart(2, "0");
      document.getElementById("timer-display").textContent = `${min}:${sec}`;
    }

    function startTimer() {
      if (timerStart) return;
      timerStart = Date.now();
      timerInterval = setInterval(updateTimerDisplay, 1000);
    }

    function stopTimer() {
      if (!timerStart) return;
      const now = Date.now();
      timerAccumulatedMs += now - timerStart;
      timerStart = null;
      clearInterval(timerInterval);
      updateTimerDisplay();
      // Joga para o campo de minutos
      const minutes = Math.round(timerAccumulatedMs / 60000);
      document.getElementById("total-time-input").value = minutes;
    }

    function resetTimer() {
      clearInterval(timerInterval);
      timerInterval = null;
      timerStart = null;
      timerAccumulatedMs = 0;
      updateTimerDisplay();
      document.getElementById("total-time-input").value = "";
    }

    // ---------- TREINO: MOOD / HUMOR ----------

    function selectMood(btn) {
      const moodButtons = document.querySelectorAll(".mood-btn");
      moodButtons.forEach(b => b.classList.remove("mood-btn-active"));
      btn.classList.add("mood-btn-active");
      document.getElementById("mood-input").value = btn.dataset.mood || "";
    }

    // ---------- TREINO: CARDIO ----------

    function renderCardioList() {
      const container = document.getElementById("cardio-list");
      if (!currentCardioEntries.length) {
        container.innerHTML =
          "<p class='text-slate-500 dark:text-slate-300 italic'>Nenhum cardio registrado ainda.</p>";
        return;
      }
      container.innerHTML = "";
      currentCardioEntries.forEach((c, idx) => {
        const div = document.createElement("div");
        div.className = "flex justify-between items-center gap-2 border border-slate-200 dark:border-slate-700 rounded px-2 py-1";
        const dist = c.distanceKm ? ` ‚Ä¢ ${c.distanceKm} km` : "";
        div.innerHTML = `
          <span>${c.type} ‚Ä¢ ${c.minutes} min${dist} ‚Ä¢ ${c.intensity}</span>
          <button class="text-[11px] text-red-500" onclick="removeCardioEntry(${idx})">remover</button>
        `;
        container.appendChild(div);
      });
    }

    function addCardioEntry() {
      const type = document.getElementById("cardio-type").value;
      const minutes = parseInt(document.getElementById("cardio-minutes").value) || 0;
      const distance = parseFloat(document.getElementById("cardio-distance").value) || 0;
      const intensity = document.getElementById("cardio-intensity").value;

      if (!minutes) {
        alert("Informe os minutos de cardio.");
        return;
      }
      currentCardioEntries.push({
        type,
        minutes,
        distanceKm: distance > 0 ? distance : null,
        intensity
      });
      document.getElementById("cardio-minutes").value = "";
      document.getElementById("cardio-distance").value = "";
      renderCardioList();
    }

    function removeCardioEntry(index) {
      currentCardioEntries.splice(index, 1);
      renderCardioList();
    }

    // ---------- TREINO: WORKOUTS / EXERC√çCIOS ----------

    function renderWorkoutButtons() {
      const container = document.getElementById("workout-buttons");
      const configContainer = document.getElementById("config-workout-buttons");
      container.innerHTML = "";
      configContainer.innerHTML = "";

      const letters = Object.keys(workouts).sort();
      if (!letters.length) {
        container.innerHTML = "<p class='text-xs text-slate-500 dark:text-slate-300'>Nenhum treino definido.</p>";
        return;
      }

      letters.forEach(letter => {
        const wo = workouts[letter];

        const btn = document.createElement("button");
        btn.className =
          "px-3 py-1 rounded-full text-xs border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700";
        if (selectedWorkout === letter) {
          btn.classList.add("bg-primary", "text-white");
        } else {
          btn.classList.add("bg-slate-50", "dark:bg-slate-800");
        }
        btn.textContent = letter;
        btn.onclick = () => {
          selectedWorkout = letter;
          renderWorkoutButtons();
          renderTodayView();
        };
        container.appendChild(btn);

        const cfgBtn = document.createElement("button");
        cfgBtn.className =
          "px-3 py-1 rounded-full text-xs border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700";
        cfgBtn.textContent = letter;
        cfgBtn.onclick = () => {
          configWorkout = letter;
          renderConfigPanel();
        };
        configContainer.appendChild(cfgBtn);
      });
    }

    function renderTodayView() {
      const container = document.getElementById("exercise-list");
      const btnSave = document.getElementById("save-today-btn");
      showTodayMsg("");

      if (!selectedWorkout || !workouts[selectedWorkout]) {
        container.innerHTML =
          "<p class='text-slate-500 dark:text-slate-300 text-sm italic'>Selecione um treino.</p>";
        btnSave.classList.add("hidden");
        return;
      }

      const workout = workouts[selectedWorkout];
      const today = todayISO();

      // Reseta cardio ao trocar treino/dia
      currentCardioEntries = [];
      renderCardioList();

      // Preencher campos b√°sicos se existir sess√£o
      const existingSession = sessions.find(
        s => s.date === today && s.workout === selectedWorkout
      );
      if (existingSession) {
        document.getElementById("total-time-input").value =
          existingSession.totalTimeMin ?? "";
        document.getElementById("sleep-input").value =
          existingSession.sleepQuality ?? 0;
        document.getElementById("energy-input").value =
          existingSession.energyLevel ?? 0;
        document.getElementById("mood-input").value =
          existingSession.moodEmoji || "";
        currentCardioEntries = existingSession.cardio || [];
        renderCardioList();

        // Selecionar emoji salvo
        const moodButtons = document.querySelectorAll(".mood-btn");
        moodButtons.forEach(b => {
          if (b.dataset.mood === existingSession.moodEmoji) {
            b.classList.add("mood-btn-active");
          } else {
            b.classList.remove("mood-btn-active");
          }
        });
      } else {
        document.getElementById("total-time-input").value = "";
        document.getElementById("sleep-input").value = 0;
        document.getElementById("energy-input").value = 0;
        document.getElementById("mood-input").value = "";
        const moodButtons = document.querySelectorAll(".mood-btn");
        moodButtons.forEach(b => b.classList.remove("mood-btn-active"));
        currentCardioEntries = [];
        renderCardioList();
      }

      // √öltimo registro por exerc√≠cio (geral) para exibir "√öltima carga"
      const html = workout.exercises.map(ex => {
        const name = ex.name;
        const allLogs = logs.filter(l => l.exercise === name)
          .sort((a, b) => b.timestamp - a.timestamp);
        const last = allLogs[0];

        // PR mais recente (caso exista)
        const lastIsPR = last && last.isPR;

        const lastText = last
          ? `√öltima carga: ${last.weight} kg (${fmtDateBR(last.date)}, Treino ${last.workout})`
          : "Sem hist√≥rico ainda";

        const fav = ex.favorite ? "‚òÖ" : "‚òÜ";

        return `
          <div class="border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-sm space-y-1" data-ex="${name}">
            <div class="flex justify-between items-start gap-2">
              <div>
                <div class="flex items-center gap-2">
                  <button type="button"
                          class="font-semibold underline decoration-dotted"
                          onclick="openGif('${name.replace(/'/g,"\\'")}', '${(ex.gif || "").replace(/'/g,"\\'")}')">
                    ${name}
                  </button>
                  <span class="text-xs px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-700">${ex.reps}</span>
                </div>
                <p class="text-[11px] mt-1 ${lastIsPR ? "text-emerald-500" : "text-slate-500 dark:text-slate-300"}">
                  ${lastText}${lastIsPR ? " ‚Ä¢ PR üî•" : ""}
                </p>
              </div>
              <button type="button" class="text-xs" onclick="toggleExerciseFavorite('${selectedWorkout}','${name.replace(/'/g,"\\'")}')">
                ${fav}
              </button>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs mt-2">
              <div>
                <label class="block mb-1">Carga (kg)</label>
                <input type="number" step="0.5" class="w-full border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700"
                       value="">
              </div>
              <div>
                <label class="block mb-1">Obs.</label>
                <input type="text" class="w-full border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700"
                       placeholder="opcional">
              </div>
            </div>
          </div>
        `;
      }).join("");

      container.innerHTML = html;
      btnSave.classList.remove("hidden");
    }

    function toggleExerciseFavorite(workoutLetter, exerciseName) {
      const w = workouts[workoutLetter];
      if (!w) return;
      const ex = w.exercises.find(e => e.name === exerciseName);
      if (!ex) return;
      ex.favorite = !ex.favorite;
      saveJSON(getUserKey(WORKOUTS_KEY_BASE), workouts);
      if (workoutLetter === selectedWorkout) {
        renderTodayView();
      }
      if (workoutLetter === configWorkout) {
        renderConfigPanel();
      }
    }

    function openGif(name, url) {
      if (!url) {
        alert("Nenhum v√≠deo cadastrado para: " + name + ". Pesquise no YouTube pelo nome do exerc√≠cio.");
        return;
      }
      window.open(url, "_blank");
    }

    // ---------- TREINO: SALVAR HOJE (LOGS + SESS√ÉO) ----------

    function saveToday() {
      if (!selectedWorkout) {
        showTodayMsg("Selecione um treino antes de salvar.");
        return;
      }
      const date = todayISO();
      const items = document.querySelectorAll("#exercise-list [data-ex]");
      const newLogs = [];

      // Prepara PR comparando com hist√≥rico ANTES de limpar dia
      items.forEach(div => {
        const name = div.dataset.ex;
        const inputs = div.querySelectorAll("input");
        const weight = parseFloat(inputs[0].value.replace(",", ".")) || 0;
        const note = inputs[1].value.trim();
        if (weight > 0 || note) {
          const prevLogsForExercise = logs.filter(l => l.exercise === name);
          const prevMax = prevLogsForExercise.length
            ? Math.max(...prevLogsForExercise.map(l => l.weight || 0))
            : 0;
          const isPR = weight > prevMax && weight > 0;
          newLogs.push({
            date,
            workout: selectedWorkout,
            exercise: name,
            weight,
            note,
            isPR,
            timestamp: Date.now(),
          });
        }
      });

      const totalTimeMin = parseInt(document.getElementById("total-time-input").value) || 0;
      const sleepQuality = parseInt(document.getElementById("sleep-input").value) || 0;
      const energyLevel = parseInt(document.getElementById("energy-input").value) || 0;
      const moodEmoji = document.getElementById("mood-input").value || "";

      const hasSessionInfo =
        totalTimeMin > 0 ||
        sleepQuality > 0 ||
        energyLevel > 0 ||
        moodEmoji ||
        currentCardioEntries.length > 0;

      if (!newLogs.length && !hasSessionInfo) {
        showTodayMsg("Nenhum dado preenchido (carga/obs ou sess√£o/cardio).");
        return;
      }

      // Remover registros anteriores do mesmo dia+treino (para n√£o duplicar)
      logs = logs.filter(l => !(l.date === date && l.workout === selectedWorkout));
      logs = logs.concat(newLogs);
      saveJSON(getUserKey(LOGS_KEY_BASE), logs);

      // Atualiza sess√£o do dia
      sessions = sessions.filter(s => !(s.date === date && s.workout === selectedWorkout));
      if (hasSessionInfo) {
        sessions.push({
          date,
          workout: selectedWorkout,
          totalTimeMin: totalTimeMin || null,
          sleepQuality,
          energyLevel,
          moodEmoji,
          cardio: currentCardioEntries.slice(),
          timestamp: Date.now(),
        });
      }
      saveJSON(getUserKey(SESSIONS_KEY_BASE), sessions);

      showTodayMsg(`Treino ${selectedWorkout} salvo.`);
      renderCalendar();
      fillExerciseSelect();
      renderExerciseHistoryChart();
      renderSummaryChart();
    }

    // ---------- TREINO: CALEND√ÅRIO / RESUMO MENSAL ----------

    function changeMonth(delta) {
      currentMonth.setMonth(currentMonth.getMonth() + delta);
      renderCalendar();
    }

    function renderCalendar() {
      const grid = document.getElementById("calendar-grid");
      const label = document.getElementById("month-label");
      const filter = document.getElementById("calendar-filter").value || "";

      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth(); // 0-11
      const firstDay = new Date(year, month, 1);
      const startWeekDay = firstDay.getDay(); // 0 domingo
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      label.textContent = firstDay.toLocaleDateString("pt-BR", { month: "long", year: "numeric" });

      grid.innerHTML = "";

      for (let i = 0; i < startWeekDay; i++) {
        const div = document.createElement("div");
        grid.appendChild(div);
      }

      const today = todayISO();
      const logsByDay = {};
      logs.forEach(l => {
        if (!logsByDay[l.date]) logsByDay[l.date] = new Set();
        logsByDay[l.date].add(l.workout);
      });

      for (let d = 1; d <= daysInMonth; d++) {
        const dayIso = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
        const div = document.createElement("div");
        div.className =
          "border border-slate-200 dark:border-slate-700 rounded px-1 py-2 text-center cursor-pointer text-xs hover:bg-slate-100 dark:hover:bg-slate-700";
        const dayTrainings = logsByDay[dayIso] ? Array.from(logsByDay[dayIso]) : [];
        let labelWorkout = "";
        if (dayTrainings.length === 1) labelWorkout = dayTrainings[0];
        else if (dayTrainings.length > 1) labelWorkout = "+";

        // filtro
        if (filter && dayTrainings.length && !dayTrainings.includes(filter)) {
          labelWorkout = "";
        }

        if (dayIso === today) {
          div.classList.add("bg-slate-200", "dark:bg-slate-600");
        }

        div.onclick = () => showDayDetails(dayIso);

        div.innerHTML = `
          <div class="font-semibold mb-1">${d}</div>
          <div class="text-xs">${labelWorkout}</div>
        `;
        grid.appendChild(div);
      }

      // resumo do m√™s
      renderMonthSummary(year, month);
    }

    function showDayDetails(dateIso) {
      lastDayDetailsDate = dateIso;
      const box = document.getElementById("day-details");
      const title = document.getElementById("day-details-title");
      const body = document.getElementById("day-details-body");

      title.textContent = `Detalhes de ${fmtDateBR(dateIso)}`;
      const dayLogs = logs
        .filter(l => l.date === dateIso)
        .sort((a, b) => a.workout.localeCompare(b.workout) || a.exercise.localeCompare(b.exercise));

      const daySessions = sessions.filter(s => s.date === dateIso);

      if (!dayLogs.length && !daySessions.length) {
        body.innerHTML = "<p class='text-xs text-slate-500 dark:text-slate-300 italic'>Nenhum registro neste dia.</p>";
        box.classList.remove("hidden");
        return;
      }

      let html = "";

      daySessions.forEach(s => {
        const cardioText = (s.cardio || []).map(c => {
          const dist = c.distanceKm ? ` ‚Ä¢ ${c.distanceKm} km` : "";
          return `${c.type} ‚Ä¢ ${c.minutes} min${dist} ‚Ä¢ ${c.intensity}`;
        }).join("<br>");
        html += `
          <div class="border border-slate-200 dark:border-slate-700 rounded p-2 mb-2 text-xs">
            <p class="font-semibold mb-1">Treino ${s.workout}</p>
            <p>Tempo de treino: ${s.totalTimeMin ? s.totalTimeMin + " min" : "n√£o informado"}</p>
            <p>Sono: ${s.sleepQuality || 0} ‚Ä¢ Energia: ${s.energyLevel || 0} ‚Ä¢ Humor: ${s.moodEmoji || "-"}</p>
            ${cardioText ? `<p class="mt-1">Cardio:<br>${cardioText}</p>` : ""}
          </div>
        `;
      });

      if (dayLogs.length) {
        html += `<div class="border border-slate-200 dark:border-slate-700 rounded p-2 text-xs">
          <p class="font-semibold mb-1">Exerc√≠cios</p>
        `;
        dayLogs.forEach(l => {
          html += `
            <p>
              <span class="font-semibold">[${l.workout}] ${l.exercise}</span> ‚Ä¢
              ${l.weight} kg
              ${l.note ? " ‚Ä¢ " + l.note : ""}
              ${l.isPR ? " ‚Ä¢ PR üî•" : ""}
            </p>
          `;
        });
        html += "</div>";
      }

      body.innerHTML = html;
      box.classList.remove("hidden");
    }

    function deleteDayLogs() {
      if (!lastDayDetailsDate) return;
      if (!confirm("Excluir todos os registros deste dia?")) return;

      logs = logs.filter(l => l.date !== lastDayDetailsDate);
      sessions = sessions.filter(s => s.date !== lastDayDetailsDate);
      saveJSON(getUserKey(LOGS_KEY_BASE), logs);
      saveJSON(getUserKey(SESSIONS_KEY_BASE), sessions);

      document.getElementById("day-details").classList.add("hidden");
      renderCalendar();
      fillExerciseSelect();
      renderExerciseHistoryChart();
      renderSummaryChart();
    }

    function renderMonthSummary(year, monthIndex) {
      const startIso = `${year}-${String(monthIndex + 1).padStart(2, "0")}-01`;
      const endIso = `${year}-${String(monthIndex + 1).padStart(2, "0")}-${String(new Date(year, monthIndex + 1, 0).getDate()).padStart(2, "0")}`;

      const monthLogs = logs.filter(l => l.date >= startIso && l.date <= endIso);
      const monthSessions = sessions.filter(s => s.date >= startIso && s.date <= endIso);

      const daysSet = new Set(monthLogs.map(l => l.date).concat(monthSessions.map(s => s.date)));
      const totalDays = daysSet.size;

      const countByWorkout = {};
      monthLogs.forEach(l => {
        countByWorkout[l.workout] = (countByWorkout[l.workout] || 0) + 1;
      });

      let totalMinutes = 0;
      let totalCardioMin = 0;
      monthSessions.forEach(s => {
        totalMinutes += s.totalTimeMin || 0;
        (s.cardio || []).forEach(c => totalCardioMin += c.minutes || 0);
      });

      let html = "";
      html += `<p>Dias com treino: <strong>${totalDays}</strong></p>`;
      const keys = Object.keys(countByWorkout).sort();
      if (keys.length) {
        html += "<p>Treinos realizados:</p><ul class='list-disc list-inside'>";
        keys.forEach(k => {
          html += `<li>Treino ${k}: ${countByWorkout[k]} registros de exerc√≠cio</li>`;
        });
        html += "</ul>";
      } else {
        html += "<p class='text-slate-500 dark:text-slate-300'>Nenhum treino neste m√™s.</p>";
      }
      html += `<p class="mt-1">Tempo total registrado: <strong>${totalMinutes}</strong> min (muscula√ß√£o) ‚Ä¢ <strong>${totalCardioMin}</strong> min (cardio)</p>`;

      document.getElementById("month-summary").innerHTML = html;
    }

    // ---------- TREINO: HIST√ìRICO / GR√ÅFICO EXERC√çCIO ----------

    function fillExerciseSelect() {
      const select = document.getElementById("exercise-select");
      if (!select) return;
      const allNames = new Set(logs.map(l => l.exercise));
      const list = Array.from(allNames).sort();
      select.innerHTML = '<option value="">-- selecione --</option>';
      list.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
    }

    function renderExerciseHistoryChart() {
      const select = document.getElementById("exercise-select");
      const name = select.value;
      const container = document.getElementById("exercise-history");

      if (!name) {
        container.innerHTML =
          "<p class='text-slate-500 dark:text-slate-300 italic text-sm'>Selecione um exerc√≠cio.</p>";
        if (exerciseChart) {
          exerciseChart.destroy();
          exerciseChart = null;
        }
        return;
      }

      const hist = logs
        .filter(l => l.exercise === name)
        .sort((a, b) => a.date.localeCompare(b.date) || a.timestamp - b.timestamp);

      if (!hist.length) {
        container.innerHTML =
          `<p class='text-slate-500 dark:text-slate-300 text-sm'>Nenhum registro ainda para "${name}".</p>`;
        if (exerciseChart) {
          exerciseChart.destroy();
          exerciseChart = null;
        }
        return;
      }

      // Agrupa por dia usando maior carga no dia
      const byDate = {};
      hist.forEach(l => {
        if (!byDate[l.date] || l.weight > byDate[l.date].weight) {
          byDate[l.date] = l;
        }
      });
      const dates = Object.keys(byDate).sort();
      const labels = dates.map(fmtDateBR);
      const data = dates.map(d => byDate[d].weight);

      const ctx = document.getElementById("exercise-chart").getContext("2d");
      if (exerciseChart) exerciseChart.destroy();
      exerciseChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Carga (kg)",
            data,
            borderWidth: 2,
            tension: 0.2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      // Lista textual
      let html = "";
      hist.slice().reverse().forEach(l => {
        html += `
          <div class="border border-slate-200 dark:border-slate-700 rounded p-2 text-xs flex justify-between">
            <div>
              <p class="font-semibold">${l.weight} kg ${l.isPR ? "‚Ä¢ PR üî•" : ""}</p>
              ${l.note ? `<p>${l.note}</p>` : ""}
            </div>
            <span class="text-slate-500 dark:text-slate-300">${fmtDateBR(l.date)} (Treino ${l.workout})</span>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // ---------- TREINO: CONFIGURAR TREINOS ----------

    let configWorkout = null;

    function renderConfigPanel() {
      const panel = document.getElementById("config-panel");
      if (!configWorkout || !workouts[configWorkout]) {
        panel.innerHTML =
          "<p class='text-sm text-slate-500 dark:text-slate-300'>Selecione um treino para editar.</p>";
        return;
      }
      const w = workouts[configWorkout];

      let html = `
        <div class="flex justify-between items-center gap-2 mb-3">
          <div>
            <p class="text-sm font-semibold">Treino ${configWorkout}</p>
            <input id="cfg-name" type="text"
                   class="mt-1 text-xs w-full border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700"
                   value="${w.nome || ""}" placeholder="Nome do treino (opcional)">
          </div>
          <button class="text-xs text-red-500 underline" onclick="deleteCurrentWorkout()">
            Excluir treino
          </button>
        </div>
      `;

      // Dropdown de exerc√≠cios prontos
      html += `
        <div class="text-xs mb-2">
          <label class="block mb-1">Escolher exerc√≠cio pronto</label>
          <select id="template-select"
                  class="w-full border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700 text-xs"
                  onchange="applyExerciseTemplate()">
            <option value="">-- selecione um exerc√≠cio --</option>
          </select>
        </div>
      `;

      html += `
        <div class="border border-dashed border-slate-300 dark:border-slate-600 rounded p-2 mb-3 text-xs space-y-2">
          <p class="font-semibold">Adicionar / editar exerc√≠cio</p>
          <div class="grid md:grid-cols-3 gap-2">
            <input id="cfg-ex-name" type="text" placeholder="Nome"
                   class="border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700">
            <input id="cfg-ex-reps" type="text" placeholder="S√©ries x reps (ex: 4x10-12)"
                   class="border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700">
            <input id="cfg-ex-gif" type="text" placeholder="URL v√≠deo/GIF (opcional)"
                   class="border border-slate-300 dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700">
          </div>
          <div class="flex justify-end gap-2">
            <button class="text-xs border border-slate-300 dark:border-slate-600 rounded px-2 py-1 hover:bg-slate-100 dark:hover:bg-slate-700"
                    onclick="clearConfigExerciseForm()">
              Limpar
            </button>
            <button class="text-xs bg-secondary text-white rounded px-3 py-1"
                    onclick="addOrUpdateExercise()">
              Salvar exerc√≠cio
            </button>
          </div>
        </div>
      `;

      if (!w.exercises || !w.exercises.length) {
        html += `<p class="text-xs text-slate-500 dark:text-slate-300">Nenhum exerc√≠cio neste treino.</p>`;
      } else {
        html += `<div class="space-y-2 text-xs">`;
        w.exercises.forEach((ex, idx) => {
          html += `
            <div class="border border-slate-200 dark:border-slate-700 rounded p-2 flex justify-between items-center gap-2">
              <div>
                <p class="font-semibold">${ex.name}</p>
                <p>${ex.reps || ""}</p>
                ${ex.gif ? `<p class="text-[11px] text-slate-500 dark:text-slate-300 truncate max-w-xs">Link: ${ex.gif}</p>` : ""}
              </div>
              <div class="flex flex-col items-end gap-1">
                <button class="text-[11px]" onclick="toggleExerciseFavorite('${configWorkout}','${ex.name.replace(/'/g,"\\'")}')">
                  ${ex.favorite ? "‚òÖ Favorito" : "‚òÜ Favorito"}
                </button>
                <div class="flex gap-1">
                  <button class="text-[11px] text-blue-500"
                          onclick="loadExerciseIntoForm(${idx})">Editar</button>
                  <button class="text-[11px] text-red-500"
                          onclick="deleteExercise(${idx})">Remover</button>
                </div>
              </div>
            </div>
          `;
        });
        html += `</div>`;
      }

      panel.innerHTML = html;

      // Preenche o select de templates depois que o HTML foi injetado
      initExerciseTemplates();
    }

    function clearConfigExerciseForm() {
      document.getElementById("cfg-ex-name").value = "";
      document.getElementById("cfg-ex-reps").value = "";
      document.getElementById("cfg-ex-gif").value = "";
      editExerciseIndex = null;
    }

    function addOrUpdateExercise() {
      if (!configWorkout || !workouts[configWorkout]) return;
      const w = workouts[configWorkout];
      const name = document.getElementById("cfg-ex-name").value.trim();
      const reps = document.getElementById("cfg-ex-reps").value.trim();
      const gif = document.getElementById("cfg-ex-gif").value.trim();

      if (!name) {
        alert("Informe o nome do exerc√≠cio.");
        return;
      }

      if (!w.exercises) w.exercises = [];

      if (editExerciseIndex !== null) {
        const ex = w.exercises[editExerciseIndex];
        ex.name = name;
        ex.reps = reps;
        ex.gif = gif;
      } else {
        w.exercises.push({ name, reps, gif, favorite: false });
      }
      w.nome = document.getElementById("cfg-name").value.trim() || w.nome;

      saveJSON(getUserKey(WORKOUTS_KEY_BASE), workouts);
      clearConfigExerciseForm();
      renderConfigPanel();
      renderWorkoutButtons();
    }

    function loadExerciseIntoForm(index) {
      if (!configWorkout || !workouts[configWorkout]) return;
      const w = workouts[configWorkout];
      const ex = w.exercises[index];
      document.getElementById("cfg-ex-name").value = ex.name || "";
      document.getElementById("cfg-ex-reps").value = ex.reps || "";
      document.getElementById("cfg-ex-gif").value = ex.gif || "";
      editExerciseIndex = index;
    }

    function deleteExercise(index) {
      if (!configWorkout || !workouts[configWorkout]) return;
      const w = workouts[configWorkout];
      if (!confirm("Remover este exerc√≠cio do treino?")) return;
      w.exercises.splice(index, 1);
      saveJSON(getUserKey(WORKOUTS_KEY_BASE), workouts);
      renderConfigPanel();
      renderWorkoutButtons();
    }

    function promptAddWorkout() {
      const letter = prompt("Informe a letra do novo treino (A-I):");
      if (!letter) return;
      const l = letter.trim().toUpperCase();
      if (!/^[A-I]$/.test(l)) {
        alert("Apenas uma letra de A a I.");
        return;
      }
      if (workouts[l]) {
        alert("J√° existe um treino com essa letra.");
        return;
      }
      const name = prompt("Nome do treino (opcional):") || `Treino ${l}`;
      workouts[l] = { nome: name, exercises: [] };
      saveJSON(getUserKey(WORKOUTS_KEY_BASE), workouts);
      configWorkout = l;
      renderWorkoutButtons();
      renderConfigPanel();
    }

    function deleteCurrentWorkout() {
      if (!configWorkout || !workouts[configWorkout]) return;
      const letter = configWorkout;
      if (!confirm(`Excluir definitivamente o treino ${letter}? Os registros antigos continuam no hist√≥rico.`)) {
        return;
      }
      delete workouts[letter];
      saveJSON(getUserKey(WORKOUTS_KEY_BASE), workouts);
      if (selectedWorkout === letter) {
        selectedWorkout = null;
        renderTodayView();
      }
      configWorkout = null;
      renderWorkoutButtons();
      renderConfigPanel();
    }

    // ---------- ALIMENTA√á√ÉO: PERFIL / META ----------

    function saveNutritionProfile() {
      const sex = document.getElementById("nutri-sex").value;
      const age = parseInt(document.getElementById("nutri-age").value) || 0;
      const height = parseInt(document.getElementById("nutri-height").value) || 0;
      const weight = parseFloat(document.getElementById("nutri-weight").value) || 0;
      const activity = parseFloat(document.getElementById("nutri-activity").value) || 1.2;
      const goal = document.getElementById("nutri-goal").value;

      if (!age || !height || !weight) {
        alert("Preencha idade, altura e peso.");
        return;
      }

      // Mifflin-St Jeor
      let tmb;
      if (sex === "M") {
        tmb = 10 * weight + 6.25 * height - 5 * age + 5;
      } else {
        tmb = 10 * weight + 6.25 * height - 5 * age - 161;
      }
      const tdee = tmb * activity;

      let target = tdee;
      if (goal === "cut") {
        target = tdee * 0.8; // -20%
      } else if (goal === "bulk") {
        target = tdee * 1.1; // +10%
      }

      nutritionProfile = {
        sex, age, height, weight, activity, goal,
        tmb: Math.round(tmb),
        tdee: Math.round(tdee),
        targetKcal: Math.round(target)
      };
      saveJSON(getUserKey(NUTRI_PROFILE_KEY_BASE), nutritionProfile);
      renderNutritionProfileUI();
      initNutritionDiary();
      renderSummaryChart();
    }

    function renderNutritionProfileUI() {
      const box = document.getElementById("nutri-result");
      if (!nutritionProfile) {
        box.innerHTML =
          "<p class='text-sm text-slate-500 dark:text-slate-300'>Nenhum perfil salvo ainda.</p>";
        return;
      }
      const p = nutritionProfile;
      let goalText = "";
      if (p.goal === "cut") goalText = "Emagrecer (d√©ficit)";
      else if (p.goal === "maintain") goalText = "Manter peso";
      else goalText = "Ganhar massa magra (super√°vit)";

      box.innerHTML = `
        <p>Sexo: <strong>${p.sex}</strong> ‚Ä¢ Idade: <strong>${p.age}</strong> ‚Ä¢ Peso: <strong>${p.weight} kg</strong> ‚Ä¢ Altura: <strong>${p.height} cm</strong></p>
        <p>TMB estimada: <strong>${p.tmb} kcal</strong></p>
        <p>Gasto di√°rio estimado (TDEE): <strong>${p.tdee} kcal</strong></p>
        <p>Objetivo: <strong>${goalText}</strong></p>
        <p class="mt-1 text-emerald-500">Meta di√°ria sugerida: <strong>${p.targetKcal} kcal</strong></p>
      `;

      // Preencher campos com valores salvos
      document.getElementById("nutri-sex").value = p.sex;
      document.getElementById("nutri-age").value = p.age;
      document.getElementById("nutri-height").value = p.height;
      document.getElementById("nutri-weight").value = p.weight;
      document.getElementById("nutri-activity").value = String(p.activity);
      document.getElementById("nutri-goal").value = p.goal;
    }



    function getDayMeals(dateIso) {
      return meals.filter(m => m.date === dateIso);
    }

    function addMeal() {
      const date = document.getElementById("meal-date").value || todayISO();
      const type = document.getElementById("meal-type").value;
      const desc = document.getElementById("meal-desc").value.trim();
      const kcal = parseInt(document.getElementById("meal-kcal").value) || 0;

      if (!kcal || !desc) {
        alert("Informe descri√ß√£o e kcal estimada.");
        return;
      }

      meals.push({
        date,
        type,
        desc,
        kcal,
        timestamp: Date.now()
      });
      saveJSON(getUserKey(MEALS_KEY_BASE), meals);

      document.getElementById("meal-desc").value = "";
      document.getElementById("meal-kcal").value = "";

      renderMealsForDate(date);
      renderSummaryChart();
    }

    function deleteMeal(index, dateIso) {
      meals.splice(index, 1);
      saveJSON(getUserKey(MEALS_KEY_BASE), meals);
      renderMealsForDate(dateIso);
      renderSummaryChart();
    }

    function renderMealsForDate(dateIso) {
      const listBox = document.getElementById("meal-list");
      const summaryBox = document.getElementById("meal-summary");
      const targetSpan = document.getElementById("nutri-day-target");

      const dayMeals = getDayMeals(dateIso);
      const total = dayMeals.reduce((acc, m) => acc + (m.kcal || 0), 0);
      const target = nutritionProfile ? nutritionProfile.targetKcal : null;

      if (targetSpan) {
        targetSpan.textContent = `Meta di√°ria: ${target ? target + " kcal" : "-- kcal (defina o perfil)"}`;
      }

      let diffText = "";
      if (target) {
        const diff = total - target;
        if (Math.abs(diff) < 20) {
          diffText = "Praticamente na meta.";
        } else if (diff > 0) {
          diffText = `Acima da meta em ${diff.toFixed(0)} kcal.`;
        } else {
          diffText = `Abaixo da meta em ${Math.abs(diff).toFixed(0)} kcal.`;
        }
      }

      summaryBox.innerHTML = `
        <p>Dia: <strong>${fmtDateBR(dateIso)}</strong></p>
        <p>Total ingerido: <strong>${total} kcal</strong></p>
        ${target ? `<p>Meta: <strong>${target} kcal</strong></p><p>${diffText}</p>` : "<p>Defina o perfil para ver a meta.</p>"}
      `;

      if (!dayMeals.length) {
        listBox.innerHTML =
          "<p class='text-xs text-slate-500 dark:text-slate-300 italic'>Nenhuma refei√ß√£o registrada neste dia.</p>";
        return;
      }

      let html = "";
      dayMeals.forEach((m, idx) => {
        html += `
          <div class="border border-slate-200 dark:border-slate-700 rounded p-2 text-xs flex justify-between items-center gap-2">
            <div>
              <p class="font-semibold">${m.type}</p>
              <p>${m.desc}</p>
              <p>${m.kcal} kcal</p>
            </div>
            <button class="text-[11px] text-red-500"
                    onclick="deleteMeal(${meals.indexOf(m)}, '${dateIso}')">
              remover
            </button>
          </div>
        `;
      });
      listBox.innerHTML = html;
    }

    // ---------- ALIMENTA√á√ÉO: TABS ----------

    function switchNutriTab(tab) {
      const ids = ["nutri-profile", "nutri-diary", "nutri-summary"];
      ids.forEach(id => document.getElementById(id).classList.add("hidden"));

      if (tab === "profile") {
        document.getElementById("nutri-profile").classList.remove("hidden");
      } else if (tab === "diary") {
        document.getElementById("nutri-diary").classList.remove("hidden");
      } else {
        document.getElementById("nutri-summary").classList.remove("hidden");
        renderSummaryChart();
      }

      document.getElementById("tab-nutri-profile").className =
        "px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700";
      document.getElementById("tab-nutri-diary").className =
        "px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700";
      document.getElementById("tab-nutri-summary").className =
        "px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700";

      document.getElementById("tab-nutri-" + tab).className =
        "px-3 py-1 rounded-full bg-primary text-white";
    }

    // ---------- RESUMO GERAL (TREINO + ALIMENTA√á√ÉO) ----------

    function estimateCardioKcal(cardio) {
      if (!cardio || !cardio.length) return 0;
      let total = 0;
      cardio.forEach(c => {
        const min = c.minutes || 0;
        let factor = 6;
        if (c.intensity === "leve") factor = 5;
        else if (c.intensity === "moderado") factor = 8;
        else if (c.intensity === "forte") factor = 11;
        total += min * factor;
      });
      return total;
    }

    function estimateStrengthKcal(totalMinutes) {
      if (!totalMinutes) return 0;
      return totalMinutes * 6; // aproxima√ß√£o
    }

    function renderSummaryChart() {
      const ctx = document.getElementById("summary-chart");
      const box = document.getElementById("summary-extra");
      if (!ctx || !box) return;

      if (!nutritionProfile) {
        box.innerHTML =
          "<p class='text-xs text-slate-500 dark:text-slate-300'>Defina o perfil de alimenta√ß√£o para ver o resumo.</p>";
        if (summaryChart) {
          summaryChart.destroy();
          summaryChart = null;
        }
        return;
      }

      const today = new Date();
      const days = [];
      for (let i = 13; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const iso = d.toISOString().slice(0, 10);
        days.push(iso);
      }

      const labels = days.map(fmtDateBR);
      const intake = [];
      const expend = [];
      const targetArr = [];

      days.forEach(dateIso => {
        const dayMeals = meals.filter(m => m.date === dateIso);
        const totalIn = dayMeals.reduce((acc, m) => acc + (m.kcal || 0), 0);

        const daySessions = sessions.filter(s => s.date === dateIso);
        let totalStrengthMin = 0;
        let totalCardioKcal = 0;
        daySessions.forEach(s => {
          totalStrengthMin += s.totalTimeMin || 0;
          totalCardioKcal += estimateCardioKcal(s.cardio || []);
        });
        const strengthKcal = estimateStrengthKcal(totalStrengthMin);

        const base = nutritionProfile.tdee || nutritionProfile.targetKcal;
        const totalExp = base + strengthKcal + totalCardioKcal;

        intake.push(totalIn);
        expend.push(Math.round(totalExp));
        targetArr.push(nutritionProfile.targetKcal);
      });

      if (summaryChart) summaryChart.destroy();
      summaryChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Ingest√£o (kcal)",
              data: intake,
              borderWidth: 2,
              tension: 0.2
            },
            {
              label: "Gasto estimado (kcal)",
              data: expend,
              borderWidth: 2,
              borderDash: [4, 2],
              tension: 0.2
            },
            {
              label: "Meta (kcal)",
              data: targetArr,
              borderWidth: 1,
              borderDash: [2, 2],
              tension: 0,
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: "index", intersect: false },
          plugins: { legend: { position: "top" } },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      box.innerHTML = `
        <p>Meta di√°ria atual: <strong>${nutritionProfile.targetKcal} kcal</strong></p>
        <p class="text-slate-500 dark:text-slate-300">
          Linhas aproximam o comportamento: n√£o substitui acompanhamento profissional,
          mas te d√° uma boa no√ß√£o do balan√ßo cal√≥rico junto com o que voc√™ fez de treino e cardio.
        </p>
      `;
    }

    // ---------- INICIALIZA√á√ÉO GERAL ----------

    window.addEventListener("load", () => {
      initTheme();
      document.getElementById("theme-toggle").addEventListener("click", toggleTheme);

      const savedUser = localStorage.getItem(CURRENT_USER_KEY);
      if (savedUser) {
        currentUser = savedUser;
        enterApp();
      }
    });
  </script>

</body>
</html>
// Helper para montar link de demonstra√ß√£o (YouTube) para templates de exerc√≠cio
const demoUrlTemplate = (nome) =>
  "https://www.youtube.com/results?search_query=" + encodeURIComponent(nome + " exerc√≠cio academia");

// ---------- Lista suspensa de exerc√≠cios prontos ----------
const EXERCISE_TEMPLATES = [
  // Perna / Gl√∫teo
  { id: "agach-livre",   grupo: "Perna / Gl√∫teo", name: "Agachamento livre",           reps: "4x8-12",           url: demoUrlTemplate("Agachamento livre barra alta") },
  { id: "agach-smith",   grupo: "Perna / Gl√∫teo", name: "Agachamento no smith",        reps: "4x10-12",          url: demoUrlTemplate("Agachamento no smith") },
  { id: "bulgaro",       grupo: "Perna / Gl√∫teo", name: "Agachamento b√∫lgaro",         reps: "3x10 cada perna",  url: demoUrlTemplate("Agachamento b√∫lgaro com banco") },
  { id: "avanco",        grupo: "Perna / Gl√∫teo", name: "Avan√ßo com halteres",         reps: "3x10 cada perna",  url: demoUrlTemplate("Avan√ßo com halteres") },
  { id: "leg45",         grupo: "Perna / Gl√∫teo", name: "Leg 45¬∫",                     reps: "4x10",             url: demoUrlTemplate("Leg press 45") },
  { id: "extensora",     grupo: "Perna / Gl√∫teo", name: "Cadeira extensora",           reps: "3-4x12",           url: demoUrlTemplate("Cadeira extensora") },
  { id: "flex-mesa",     grupo: "Perna / Gl√∫teo", name: "Mesa flexora",                reps: "3-4x10-12",        url: demoUrlTemplate("Mesa flexora deitado") },
  { id: "flex-cadeira",  grupo: "Perna / Gl√∫teo", name: "Cadeira flexora",             reps: "3-4x12",           url: demoUrlTemplate("Cadeira flexora sentado") },
  { id: "abdutora",      grupo: "Perna / Gl√∫teo", name: "Cadeira abdutora",            reps: "3x15",             url: demoUrlTemplate("Cadeira abdutora") },
  { id: "adutora",       grupo: "Perna / Gl√∫teo", name: "Adutora m√°quina",             reps: "3x15",             url: demoUrlTemplate("Cadeira adutora") },
  { id: "elev-pelvica",  grupo: "Perna / Gl√∫teo", name: "Eleva√ß√£o p√©lvica",            reps: "4x10-12",          url: demoUrlTemplate("Hip thrust eleva√ß√£o p√©lvica") },
  { id: "pant-maq",      grupo: "Perna / Gl√∫teo", name: "Panturrilha na m√°quina",      reps: "4x15-20",          url: demoUrlTemplate("Panturrilha em p√© m√°quina") },
  { id: "pant-smith",    grupo: "Perna / Gl√∫teo", name: "Panturrilha no smith",        reps: "4x15-20",          url: demoUrlTemplate("Panturrilha em p√© no smith") },

  // Costas / B√≠ceps
  { id: "pux-frente",    grupo: "Costas / B√≠ceps", name: "Puxador frente",             reps: "4x10-12",          url: demoUrlTemplate("Puxada frente barra aberta polia alta") },
  { id: "pux-sup",       grupo: "Costas / B√≠ceps", name: "Puxador frente supinado",    reps: "4x10-12",          url: demoUrlTemplate("Puxada frente pegada supinada") },
  { id: "rem-curv-bar",  grupo: "Costas / B√≠ceps", name: "Remada curvada barra",       reps: "4x8-10",           url: demoUrlTemplate("Remada curvada barra") },
  { id: "rem-caval",     grupo: "Costas / B√≠ceps", name: "Remada cavalinho",           reps: "4x10-12",          url: demoUrlTemplate("Remada cavalinho m√°quina") },
  { id: "rem-baixa",     grupo: "Costas / B√≠ceps", name: "Remada baixa",               reps: "4x10-12",          url: demoUrlTemplate("Remada baixa polia") },
  { id: "rosca-direta",  grupo: "Costas / B√≠ceps", name: "Rosca direta barra",         reps: "3-4x8-12",         url: demoUrlTemplate("Rosca direta barra w") },
  { id: "rosca-alt",     grupo: "Costas / B√≠ceps", name: "Rosca alternada",            reps: "3x10-12",          url: demoUrlTemplate("Rosca alternada halteres") },
  { id: "rosca-martelo", grupo: "Costas / B√≠ceps", name: "Rosca martelo",              reps: "3x10-12",          url: demoUrlTemplate("Rosca martelo halteres") },

  // Peito / Ombro / Tr√≠ceps
  { id: "sup-reto-bar",  grupo: "Peito / Ombro / Tr√≠ceps", name: "Supino reto barra",  reps: "4x8-10",           url: demoUrlTemplate("Supino reto barra") },
  { id: "sup-reto-maq",  grupo: "Peito / Ombro / Tr√≠ceps", name: "Supino reto m√°quina",reps: "4x10-12",          url: demoUrlTemplate("Supino reto na m√°quina") },
  { id: "sup-incl-hal",  grupo: "Peito / Ombro / Tr√≠ceps", name: "Supino inclinado halteres", reps: "3-4x8-12", url: demoUrlTemplate("Supino inclinado halteres") },
  { id: "fly-maq",       grupo: "Peito / Ombro / Tr√≠ceps", name: "Fly m√°quina (peck deck)", reps: "3-4x10-12",   url: demoUrlTemplate("Fly peck deck") },
  { id: "desenv-hal",    grupo: "Peito / Ombro / Tr√≠ceps", name: "Desenvolvimento com halteres", reps: "3-4x8-12", url: demoUrlTemplate("Desenvolvimento ombro halteres sentado") },
  { id: "ele-lateral",   grupo: "Peito / Ombro / Tr√≠ceps", name: "Eleva√ß√£o lateral",   reps: "3-4x12-15",        url: demoUrlTemplate("Eleva√ß√£o lateral ombro halteres") },
  { id: "tric-corda",    grupo: "Peito / Ombro / Tr√≠ceps", name: "Tr√≠ceps corda polia alta", reps: "3-4x10-12",  url: demoUrlTemplate("Tr√≠ceps corda polia alta") },
  { id: "tric-testa",    grupo: "Peito / Ombro / Tr√≠ceps", name: "Tr√≠ceps testa",      reps: "3x10-12",          url: demoUrlTemplate("Tr√≠ceps testa barra w") },
  { id: "merg-banco",    grupo: "Peito / Ombro / Tr√≠ceps", name: "Mergulho no banco",  reps: "3x10-15",          url: demoUrlTemplate("Mergulho banco tr√≠ceps") },

  // Core / Abd√¥men
  { id: "abd-supra",     grupo: "Core / Abd√¥men", name: "Abdominal supra",             reps: "3-4x15-20",        url: demoUrlTemplate("Abdominal supra no solo") },
  { id: "abd-infra",     grupo: "Core / Abd√¥men", name: "Abdominal infra",             reps: "3-4x15-20",        url: demoUrlTemplate("Abdominal infra no banco") },
  { id: "abd-obliquo",   grupo: "Core / Abd√¥men", name: "Abdominal obl√≠quo",           reps: "3-4x20 totais",    url: demoUrlTemplate("Abdominal obl√≠quo solo") },
  { id: "prancha",       grupo: "Core / Abd√¥men", name: "Prancha isom√©trica",          reps: "3x30-40s",         url: demoUrlTemplate("Prancha isom√©trica abd√¥men") },
  { id: "prancha-lat",   grupo: "Core / Abd√¥men", name: "Prancha lateral",             reps: "3x20-30s cada lado", url: demoUrlTemplate("Prancha lateral isom√©trica") },
];

// Preenche o menu suspenso com exerc√≠cios prontos na aba de configura√ß√£o
function initExerciseTemplates() {
  const sel = document.getElementById("template-select");
  if (!sel) return;

  sel.innerHTML = `<option value="">-- selecione um exerc√≠cio --</option>`;

  EXERCISE_TEMPLATES.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t.id;
    opt.textContent = `${t.grupo} ‚Äî ${t.name} (${t.reps})`;
    sel.appendChild(opt);
  });
}

// Ao selecionar um exerc√≠cio pronto, preenche o formul√°rio de configura√ß√£o
function applyExerciseTemplate() {
  const sel = document.getElementById("template-select");
  if (!sel) return;
  const id = sel.value;
  if (!id) return;

  const t = EXERCISE_TEMPLATES.find(x => x.id === id);
  if (!t) return;

  const nameInput = document.getElementById("cfg-ex-name");
  const repsInput = document.getElementById("cfg-ex-reps");
  const gifInput  = document.getElementById("cfg-ex-gif");

  if (nameInput) nameInput.value = t.name;
  if (repsInput) repsInput.value = t.reps;
  if (gifInput)  gifInput.value  = t.url || "";
}
